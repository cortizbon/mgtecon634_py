
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>7. Tutorial to simulate data using WGANs &#8212; MGTECON 634 at Stanford (Python scripts)</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8. Athey, S., Chetty, R., Imbens, G. W., &amp; Kang, H. (2019). The surrogate index: Combining short-term proxies to estimate long-term treatment effects more rapidly and precisely (No. w26463). National Bureau of Economic Research." href="9_surrogate_py.html" />
    <link rel="prev" title="6. Policy Learning I - Binary Treatment" href="6_policy_learning_1.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">MGTECON 634 at Stanford (Python scripts)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../md/intro.html">
                    Machine Learning-Based Causal Inference
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topics
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="1_introduction_1.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2_introduction_to_machine_learning.html">
   2. Introduction to Machine Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="3_average_treatment_effect_1.html">
   3. ATE I: Binary treatment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="4_heterogeneous_treatment_effect_1.html">
   4. HTE I: Binary treatment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="5_policy_evaluation_1.html">
   5. Policy Evaluation I - Binary Treatment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="6_policy_learning_1.html">
   6. Policy Learning I - Binary Treatment
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   7. Tutorial to simulate data using WGANs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="9_surrogate_py.html">
   8. Athey, S., Chetty, R., Imbens, G. W., &amp; Kang, H. (2019). The surrogate index: Combining short-term proxies to estimate long-term treatment effects more rapidly and precisely (No. w26463). National Bureau of Economic Research.
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/d2cml-ai/mgtecon634_python/master?urlpath=tree/_build/jupyter_execute/notebooks/8_WGANs_for_simulation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/d2cml-ai/mgtecon634_python/blob/master/_build/jupyter_execute/notebooks/8_WGANs_for_simulation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/d2cml-ai/mgtecon634_python"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/d2cml-ai/mgtecon634_python/issues/new?title=Issue%20on%20page%20%2Fnotebooks/8_WGANs_for_simulation.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/d2cml-ai/mgtecon634_python/edit/master/_build/jupyter_execute/notebooks/8_WGANs_for_simulation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/notebooks/8_WGANs_for_simulation.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulating-data">
   7.1. Simulating Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#steps-0-3">
     7.1.1. Steps 0-3
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#steps-4-5">
     7.1.2. Steps 4 &amp; 5
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#steps-6-8">
     7.1.3. Steps 6 &amp; 8
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#application-of-the-simulated-data-to-the-code-of-chapter-3">
   7.2. Application of the simulated data to the code of chapter 3.
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#notation-and-definitions">
     7.2.1. Notation and definitions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#difference-in-means-estimator">
     7.2.2. Difference-in-means estimator
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#turning-an-experimental-dataset-into-an-observational-one">
     7.2.3. Turning an experimental dataset into an observational one
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#direct-estimation">
     7.2.4. Direct estimation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#inverse-propensity-weighted-estimator">
     7.2.5. Inverse propensity-weighted estimator
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#augmented-inverse-propensity-weighted-aipw-estimator">
   7.3. Augmented inverse propensity-weighted (AIPW) estimator
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#diagnostics">
     7.3.1. Diagnostics
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#assessing-balance">
     7.3.2. Assessing balance
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#assessing-overlap">
       7.3.2.1. Assessing overlap
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Tutorial to simulate data using WGANs</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#simulating-data">
   7.1. Simulating Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#steps-0-3">
     7.1.1. Steps 0-3
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#steps-4-5">
     7.1.2. Steps 4 &amp; 5
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#steps-6-8">
     7.1.3. Steps 6 &amp; 8
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#application-of-the-simulated-data-to-the-code-of-chapter-3">
   7.2. Application of the simulated data to the code of chapter 3.
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#notation-and-definitions">
     7.2.1. Notation and definitions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#difference-in-means-estimator">
     7.2.2. Difference-in-means estimator
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#turning-an-experimental-dataset-into-an-observational-one">
     7.2.3. Turning an experimental dataset into an observational one
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#direct-estimation">
     7.2.4. Direct estimation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#inverse-propensity-weighted-estimator">
     7.2.5. Inverse propensity-weighted estimator
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#augmented-inverse-propensity-weighted-aipw-estimator">
   7.3. Augmented inverse propensity-weighted (AIPW) estimator
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#diagnostics">
     7.3.1. Diagnostics
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#assessing-balance">
     7.3.2. Assessing balance
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#assessing-overlap">
       7.3.2.1. Assessing overlap
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="tutorial-to-simulate-data-using-wgans">
<h1><span class="section-number">7. </span>Tutorial to simulate data using WGANs<a class="headerlink" href="#tutorial-to-simulate-data-using-wgans" title="Permalink to this headline">#</a></h1>
<p>Take into account the next notes if you run the code on Google colab.</p>
<p><font color='dark'><strong>Note 1: If you care about speed, make sure your colab runtime uses a GPU. Do this by selecting ‘Runtime’ -&gt; ‘Change Runtime Type’ -&gt; ‘Hardware Accelerator’ -&gt; ‘GPU’ (the runtime will restart and you’ll have to re-run this section).</strong> </font></p>
<p>We install the wgan package.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip3 install git+https://github.com/gsbDBI/ds-wgan
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Collecting git+https://github.com/gsbDBI/ds-wgan
  Cloning https://github.com/gsbDBI/ds-wgan to /tmp/pip-req-build-e8vqckt3
  Running command git clone --filter=blob:none --quiet https://github.com/gsbDBI/ds-wgan /tmp/pip-req-build-e8vqckt3
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  Resolved https://github.com/gsbDBI/ds-wgan to commit a65686832ea5bba27f1c6175c252769dc00b2cc3
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  Preparing metadata (setup.py) ... ?25l-
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> done
?25hRequirement already satisfied: numpy in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from wgan==0.2) (1.23.3)
Requirement already satisfied: torch&gt;=1.1.0 in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from wgan==0.2) (1.12.1)
Requirement already satisfied: pandas in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from wgan==0.2) (1.5.0)
Requirement already satisfied: matplotlib in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from wgan==0.2) (3.6.0)
Requirement already satisfied: typing-extensions in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from torch&gt;=1.1.0-&gt;wgan==0.2) (4.3.0)
Requirement already satisfied: pyparsing&gt;=2.2.1 in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from matplotlib-&gt;wgan==0.2) (3.0.9)
Requirement already satisfied: cycler&gt;=0.10 in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from matplotlib-&gt;wgan==0.2) (0.11.0)
Requirement already satisfied: pillow&gt;=6.2.0 in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from matplotlib-&gt;wgan==0.2) (9.2.0)
Requirement already satisfied: kiwisolver&gt;=1.0.1 in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from matplotlib-&gt;wgan==0.2) (1.4.4)
Requirement already satisfied: packaging&gt;=20.0 in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from matplotlib-&gt;wgan==0.2) (21.3)
Requirement already satisfied: fonttools&gt;=4.22.0 in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from matplotlib-&gt;wgan==0.2) (4.37.3)
Requirement already satisfied: python-dateutil&gt;=2.7 in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from matplotlib-&gt;wgan==0.2) (2.8.2)
Requirement already satisfied: contourpy&gt;=1.0.1 in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from matplotlib-&gt;wgan==0.2) (1.0.5)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: pytz&gt;=2020.1 in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from pandas-&gt;wgan==0.2) (2022.2.1)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: six&gt;=1.5 in /opt/hostedtoolcache/Python/3.8.14/x64/lib/python3.8/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib-&gt;wgan==0.2) (1.16.0)
</pre></div>
</div>
</div>
</div>
<p>We want to simulate a rdata so we neeed pyreadr library.</p>
<section id="simulating-data">
<h2><span class="section-number">7.1. </span>Simulating Data<a class="headerlink" href="#simulating-data" title="Permalink to this headline">#</a></h2>
<p>The workflow for every single distribution you want to fit:</p>
<ol class="simple">
<li><p>Load and prepare the data</p></li>
<li><p>Initialize a <code class="docutils literal notranslate"><span class="pre">wgan.DataWrapper</span></code> object, which takes care of handling the data</p></li>
<li><p>Initialize <code class="docutils literal notranslate"><span class="pre">wgan.Specifications</span></code> object given the <code class="docutils literal notranslate"><span class="pre">DataWrapper</span></code>, which summarizes hyperparameters, etc.</p></li>
<li><p>Initialize <code class="docutils literal notranslate"><span class="pre">wgan.Generator</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">wgan.Critic</span></code> given the <code class="docutils literal notranslate"><span class="pre">Specifications</span></code></p></li>
<li><p>Preprocess the data with the <code class="docutils literal notranslate"><span class="pre">DataWrapper</span></code> object</p></li>
<li><p>Train the <code class="docutils literal notranslate"><span class="pre">Generator</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">Critic</span></code> via <code class="docutils literal notranslate"><span class="pre">wgan.train</span></code></p></li>
<li><p>Replace columns in df with simulated data from <code class="docutils literal notranslate"><span class="pre">Generator</span></code> using <code class="docutils literal notranslate"><span class="pre">DataWrapper.apply_generator</span></code></p></li>
<li><p>If you’re interested in them, add the <code class="docutils literal notranslate"><span class="pre">Critic</span></code> outputs to the original and/or the generated df via <code class="docutils literal notranslate"><span class="pre">DataWrapper.apply_critic</span></code></p></li>
<li><p>Explore the data via <code class="docutils literal notranslate"><span class="pre">compare_dfs</span></code> &amp; save the new data.</p></li>
</ol>
<p>Since <strong>we’re fitting two distributions</strong> (Y on X and w, as well as X on w), we’ll have to do all these steps twice.
To keep the code concise, we will put the two versions of every obejct type into one list respectively. Watch out so you <strong>don’t get confused by that</strong>!</p>
<section id="steps-0-3">
<h3><span class="section-number">7.1.1. </span>Steps 0-3<a class="headerlink" href="#steps-0-3" title="Permalink to this headline">#</a></h3>
<p>First load a data file from our project repo</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span> 
<span class="kn">import</span> <span class="nn">wgan</span> 
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1">## loading the data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;https://docs.google.com/uc?id=1kSxrVci_EUcSr_Lg1JKk1l7Xd5I9zfRC&amp;export=download&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(28653, 9)
</pre></div>
</div>
</div>
</div>
<p>The data we are trying to replicate here is the one we used in Chapter 3.</p>
<p>After loading in our data as <code class="docutils literal notranslate"><span class="pre">df</span></code>, we will build from it second dataframe called <code class="docutils literal notranslate"><span class="pre">df_balanced</span></code>, by sampling treated and controls with similar probability from <code class="docutils literal notranslate"><span class="pre">df</span></code>. We will train our WGAN on <code class="docutils literal notranslate"><span class="pre">df_balanced</span></code>, which makes sure the quality of the generated outcomes is similar for both treatment groups.</p>
<p>We will need to differentiate categorical from continous variable so we need to identify which variables are continous and categorical.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We observe the minimum and maximum age from the age variable of the data set to create continuous upper and lower bounds.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Minimum and maximum age&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age</span><span class="p">))</span>
<span class="c1"># We also check the maximun years of education to create continuous upper and lower bounds.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maximum number of years of education&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">educ</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Minimum and maximum age
18
89
Maximum number of years of education
20
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_balanced</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">df</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">*</span><span class="n">df</span><span class="o">.</span><span class="n">w</span><span class="o">+</span><span class="n">df</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">df</span><span class="o">.</span><span class="n">w</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># balanced df for training</span>

<span class="c1">#We does not simulate X variable because it is a kind of id</span>

<span class="c1"># X | tg        This X here represents the set of covariates</span>
<span class="n">continuous_vars_0</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;educ&quot;</span><span class="p">]</span>
<span class="n">continuous_lower_bounds_0</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;age&quot;</span><span class="p">:</span><span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;educ&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="n">continuous_upper_bounds_0</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;age&quot;</span><span class="p">:</span><span class="mi">89</span><span class="p">,</span> <span class="s2">&quot;educ&quot;</span><span class="p">:</span><span class="mi">20</span><span class="p">}</span>
<span class="n">categorical_vars_0</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;marital&quot;</span><span class="p">,</span><span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;polviews&quot;</span><span class="p">,</span> <span class="s2">&quot;income&quot;</span><span class="p">]</span>
<span class="n">context_vars_0</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span>

<span class="c1"># Y | X, tg</span>
<span class="n">continuous_vars_1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">continuous_lower_bounds_1</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">continuous_upper_bounds_1</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">categorical_vars_1</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
<span class="n">context_vars_1</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">,</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="s2">&quot;educ&quot;</span><span class="p">,</span> <span class="s2">&quot;marital&quot;</span><span class="p">,</span><span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;polviews&quot;</span><span class="p">]</span>

<span class="c1"># Initialize objects</span>
<span class="n">data_wrappers</span> <span class="o">=</span> <span class="p">[</span><span class="n">wgan</span><span class="o">.</span><span class="n">DataWrapper</span><span class="p">(</span><span class="n">df_balanced</span><span class="p">,</span> <span class="n">continuous_vars_0</span><span class="p">,</span> <span class="n">categorical_vars_0</span><span class="p">,</span> 
                                  <span class="n">context_vars_0</span><span class="p">,</span> <span class="n">continuous_lower_bounds_0</span><span class="p">,</span> <span class="n">continuous_upper_bounds_0</span><span class="p">),</span>
                 <span class="n">wgan</span><span class="o">.</span><span class="n">DataWrapper</span><span class="p">(</span><span class="n">df_balanced</span><span class="p">,</span> <span class="n">continuous_vars_1</span><span class="p">,</span> <span class="n">categorical_vars_1</span><span class="p">,</span> 
                                  <span class="n">context_vars_1</span><span class="p">,</span> <span class="n">continuous_lower_bounds_1</span><span class="p">,</span> <span class="n">continuous_upper_bounds_1</span><span class="p">)]</span>
<span class="n">specs</span> <span class="o">=</span> <span class="p">[</span><span class="n">wgan</span><span class="o">.</span><span class="n">Specifications</span><span class="p">(</span><span class="n">dw</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">max_epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">critic_lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">generator_lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
                             <span class="n">print_every</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">dw</span> <span class="ow">in</span> <span class="n">data_wrappers</span><span class="p">]</span> <span class="c1">#use &quot;cuda&quot; on device option if you have GPU (faster) and &quot;cpu&quot; if you don&#39;t  have</span>
<span class="n">generators</span> <span class="o">=</span> <span class="p">[</span><span class="n">wgan</span><span class="o">.</span><span class="n">Generator</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>
<span class="n">critics</span> <span class="o">=</span> <span class="p">[</span><span class="n">wgan</span><span class="o">.</span><span class="n">Critic</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>settings: {&#39;optimizer&#39;: &lt;class &#39;torch.optim.adam.Adam&#39;&gt;, &#39;critic_d_hidden&#39;: [128, 128, 128], &#39;critic_dropout&#39;: 0, &#39;critic_steps&#39;: 15, &#39;critic_lr&#39;: 0.001, &#39;critic_gp_factor&#39;: 5, &#39;generator_d_hidden&#39;: [128, 128, 128], &#39;generator_dropout&#39;: 0.1, &#39;generator_lr&#39;: 0.001, &#39;generator_d_noise&#39;: 28, &#39;generator_optimizer&#39;: &#39;optimizer&#39;, &#39;max_epochs&#39;: 1000, &#39;batch_size&#39;: 6000, &#39;test_set_size&#39;: 16, &#39;load_checkpoint&#39;: None, &#39;save_checkpoint&#39;: None, &#39;save_every&#39;: 100, &#39;print_every&#39;: 100, &#39;device&#39;: &#39;cpu&#39;}
settings: {&#39;optimizer&#39;: &lt;class &#39;torch.optim.adam.Adam&#39;&gt;, &#39;critic_d_hidden&#39;: [128, 128, 128], &#39;critic_dropout&#39;: 0, &#39;critic_steps&#39;: 15, &#39;critic_lr&#39;: 0.001, &#39;critic_gp_factor&#39;: 5, &#39;generator_d_hidden&#39;: [128, 128, 128], &#39;generator_dropout&#39;: 0.1, &#39;generator_lr&#39;: 0.001, &#39;generator_d_noise&#39;: 2, &#39;generator_optimizer&#39;: &#39;optimizer&#39;, &#39;max_epochs&#39;: 1000, &#39;batch_size&#39;: 6000, &#39;test_set_size&#39;: 16, &#39;load_checkpoint&#39;: None, &#39;save_checkpoint&#39;: None, &#39;save_every&#39;: 100, &#39;print_every&#39;: 100, &#39;device&#39;: &#39;cpu&#39;}
</pre></div>
</div>
</div>
</div>
</section>
<section id="steps-4-5">
<h3><span class="section-number">7.1.2. </span>Steps 4 &amp; 5<a class="headerlink" href="#steps-4-5" title="Permalink to this headline">#</a></h3>
<p>Next, we train the model. How long this will take depends on the batch_size, the size of your data set and the max_epochs you specified.</p>
<p>You can also abort at any time, the model will keep its parameters at their most recent values during training. You can also resume the training, but this resets the optimizer state which basically means you might as well repeat at Step 3.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># train X | t</span>
<span class="n">x</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">data_wrappers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">df_balanced</span><span class="p">)</span>
<span class="n">wgan</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">generators</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">critics</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">specs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 0 | step 6 | WD_test 0.11 | WD_train 0.04 | sec passed 1 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 100 | step 506 | WD_test 1.32 | WD_train 1.37 | sec passed 81 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 200 | step 1006 | WD_test 1.12 | WD_train 1.09 | sec passed 80 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 300 | step 1506 | WD_test 0.85 | WD_train 0.82 | sec passed 81 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 400 | step 2006 | WD_test 0.78 | WD_train 0.68 | sec passed 81 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 500 | step 2506 | WD_test 0.47 | WD_train 0.61 | sec passed 80 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 600 | step 3006 | WD_test 0.63 | WD_train 0.53 | sec passed 82 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 700 | step 3506 | WD_test 1.62 | WD_train 2.0 | sec passed 81 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 800 | step 4006 | WD_test 1.09 | WD_train 1.25 | sec passed 81 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 900 | step 4506 | WD_test 1.12 | WD_train 0.97 | sec passed 82 |
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># train Y | X, t</span>
<span class="n">x</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">data_wrappers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">df_balanced</span><span class="p">)</span>
<span class="n">wgan</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">generators</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">critics</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">specs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 0 | step 6 | WD_test 0.0 | WD_train 0.02 | sec passed 1 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 100 | step 506 | WD_test 0.9 | WD_train 0.35 | sec passed 77 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 200 | step 1006 | WD_test 0.88 | WD_train 0.37 | sec passed 77 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 300 | step 1506 | WD_test 0.67 | WD_train 0.28 | sec passed 77 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 400 | step 2006 | WD_test 0.23 | WD_train 0.18 | sec passed 76 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 500 | step 2506 | WD_test 0.03 | WD_train 0.04 | sec passed 76 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 600 | step 3006 | WD_test 0.25 | WD_train 0.03 | sec passed 76 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 700 | step 3506 | WD_test 0.39 | WD_train 0.05 | sec passed 76 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 800 | step 4006 | WD_test -0.02 | WD_train 0.07 | sec passed 76 |
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch 900 | step 4506 | WD_test 0.27 | WD_train 0.08 | sec passed 76 |
</pre></div>
</div>
</div>
</div>
</section>
<section id="steps-6-8">
<h3><span class="section-number">7.1.3. </span>Steps 6 &amp; 8<a class="headerlink" href="#steps-6-8" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simulate data with conditional WGANs</span>
<span class="n">df_generated1</span> <span class="o">=</span> <span class="n">data_wrappers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">apply_generator</span><span class="p">(</span><span class="n">generators</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df</span><span class="p">)</span>
<span class="n">df_generated1</span> <span class="o">=</span> <span class="n">data_wrappers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">apply_generator</span><span class="p">(</span><span class="n">generators</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">df_generated1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Compare fake and real data</span>
<span class="n">wgan</span><span class="o">.</span><span class="n">compare_dfs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df_generated1</span><span class="p">,</span>
                 <span class="n">histogram</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;educ&quot;</span><span class="p">],</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                 <span class="n">figsize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-------------comparison of means-------------
source        fake      real
X         17552.04  17552.04
y             0.24      0.25
w             0.53      0.53
age          44.43     45.30
polviews      4.21      4.11
income       11.01     10.60
educ         13.26     13.29
marital       2.48      2.40
sex           1.56      1.55
-------------comparison of stds-------------
source        fake      real
X         10789.54  10789.54
y             0.43      0.44
w             0.50      0.50
age          13.82     16.85
polviews      1.11      1.39
income        1.91      2.47
educ          3.15      2.98
marital       1.68      1.64
sex           0.50      0.50
</pre></div>
</div>
<img alt="../_images/8_WGANs_for_simulation_22_1.png" src="../_images/8_WGANs_for_simulation_22_1.png" />
<img alt="../_images/8_WGANs_for_simulation_22_2.png" src="../_images/8_WGANs_for_simulation_22_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Scatter plot from Y and the 2 continuous variables&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_generated1</span><span class="o">.</span><span class="n">age</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;Red&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;Blue&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Fake&quot;</span><span class="p">,</span><span class="s2">&quot;Real&quot;</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_generated1</span><span class="o">.</span><span class="n">educ</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;Red&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">educ</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;educ&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Fake&quot;</span><span class="p">,</span><span class="s2">&quot;Real&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7ff8f533c070&gt;
</pre></div>
</div>
<img alt="../_images/8_WGANs_for_simulation_23_1.png" src="../_images/8_WGANs_for_simulation_23_1.png" />
</div>
</div>
<p>As we can observe, the means, standard error, correlation matrix and distributions (histograms) of the real and simulated data are pretty similar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">df_generated1</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="application-of-the-simulated-data-to-the-code-of-chapter-3">
<h2><span class="section-number">7.2. </span>Application of the simulated data to the code of chapter 3.<a class="headerlink" href="#application-of-the-simulated-data-to-the-code-of-chapter-3" title="Permalink to this headline">#</a></h2>
<p>Now we can use this new simulated data in the code from chapter 3 which evaluate the Average Treatment Effect (ATE) in Binary treatment. So we can first recall some of the notations and definitions from the original data because these new simulated data are supposed to have the same definitions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#pip install pypng</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#pip install requests</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#pip install econml</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#First we import the necesary packages to use in chapter 3 code</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">patsy</span>
<span class="kn">import</span> <span class="nn">patsy</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.mlab</span> <span class="k">as</span> <span class="nn">mlab</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">imageio</span> <span class="k">as</span> <span class="nn">iio</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mpimg</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">import</span> <span class="nn">png</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">line</span> <span class="mi">11</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="kn">import</span> <span class="nn">matplotlib.mlab</span> <span class="k">as</span> <span class="nn">mlab</span>
<span class="ne">---&gt; </span><span class="mi">11</span> <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="kn">import</span> <span class="nn">random</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="kn">import</span> <span class="nn">string</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;seaborn&#39;
</pre></div>
</div>
</div>
</div>
<section id="notation-and-definitions">
<h3><span class="section-number">7.2.1. </span>Notation and definitions<a class="headerlink" href="#notation-and-definitions" title="Permalink to this headline">#</a></h3>
<p>Let’s establish some notation. Each data point will be defined by the triple <span class="math notranslate nohighlight">\((X_i, W_i, Y_i)\)</span>. The vector <span class="math notranslate nohighlight">\(X_i\)</span> represents covariates that are observed for individual <span class="math notranslate nohighlight">\(i\)</span>. Treatment assignment is indicated by <span class="math notranslate nohighlight">\(W_i \in \{0, 1\}\)</span>, with 1 representing treatment, and 0 representing control. The scalar <span class="math notranslate nohighlight">\(Y_i\)</span> is the observed outcome, and it can be real or binary. Each observation is drawn independently and from the same distribution. We’ll be interested in assessing the causal effect of treatment on outcome.</p>
<p>A difficulty in estimating causal quantities is that we observe each individual in only one treatment state: either they were treated, or they weren’t. However, it’s often useful to imagine that each individual is endowed with two random variables <span class="math notranslate nohighlight">\((Y_i(1), Y_i(0))\)</span>, where <span class="math notranslate nohighlight">\(Y_i(1)\)</span> represents the value of this individual’s outcome if they receive treatment, and <span class="math notranslate nohighlight">\(Y_i(0)\)</span> represents their outcome if they are not treated. These random variables are called  <strong>potential outcomes</strong>. The observed outcome <span class="math notranslate nohighlight">\(Y_i\)</span> corresponds to whichever potential outcome we got to see:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
  Y_i \equiv Y_i(W_i) =
  \begin{cases}
    Y_i(1) \qquad \text{if }W_i = 1 \text{ (treated)} \\ 
    Y_i(0) \qquad \text{if }W_i = 0 \text{ (control)}\\ 
  \end{cases}
\end{split}\]</div>
<p>Since we can’t observe both <span class="math notranslate nohighlight">\(Y_i(1)\)</span> and <span class="math notranslate nohighlight">\(Y_i(0)\)</span>, we won’t be able to make statistical claims about the individual treatment effect <span class="math notranslate nohighlight">\(Y_i(1) - Y_i(0)\)</span>. Instead, our goal will be to estimate the <strong>average treatment effect (ATE)</strong>:</p>
<div class="math notranslate nohighlight" id="equation-ate">
<span class="eqno">(7.1)<a class="headerlink" href="#equation-ate" title="Permalink to this equation">#</a></span>\[
  \tau := \mathbf{E}[Y_i(1) - Y_i(0)].
\]</div>
<p>Here, when we refer to the <strong>randomized</strong> setting we mean that we have data generated by a randomized control trial. The key characteristic of this setting is that the probability that an individual is assigned to the treatment arm is fixed. In particular, it does not depend on the individual’s potential outcomes:</p>
<div class="math notranslate nohighlight" id="equation-unconf">
<span class="eqno">(7.2)<a class="headerlink" href="#equation-unconf" title="Permalink to this equation">#</a></span>\[
  Y_i(1), Y_i(0) \perp W_i.
\]</div>
<p>This precludes situations in which individuals may self-select into or out of treatment. The canonical failure example is a job training program in which workers enroll more often if they are more likely to benefit from treatment because in that case <span class="math notranslate nohighlight">\(W_i\)</span> and <span class="math notranslate nohighlight">\(Y_i(1) - Y_i(0)\)</span> would be positively correlated.</p>
<p>When condition <a class="reference internal" href="#equation-unconf">(7.2)</a> is violated, we say that we are in an <strong>observational</strong> setting. This is a more complex setting encompassing several different scenarios: sometimes it’s still possible to estimate the ATE under additional assumptions, sometimes the researcher can exploit other sources of variation to obtain other interesting estimands. Here, we will focus on ATE estimation under the following assumption:</p>
<div class="math notranslate nohighlight" id="equation-unconf-1">
<span class="eqno">(7.3)<a class="headerlink" href="#equation-unconf-1" title="Permalink to this equation">#</a></span>\[
  Y_i(1), Y_i(0) \perp W_i \ | \ X_i.
\]</div>
<p>In this document we will call this assumption <strong>unconfoundeness</strong>, though it is also known as <strong>no unmeasured confounders</strong>, <strong>ignorability</strong> or <strong>selection on observables</strong>. It says that all possible sources of self-selection, etc., can be explained by the observable covariates <span class="math notranslate nohighlight">\(X_i\)</span>. Continuing the example above, it may be that older or more educated are more likely to self-select into treatment; but when we compare two workers that have the same age and level of education, etc., there’s nothing else that we could infer about their relative potential outcomes if we knew that one went into job training and the other did not.</p>
<p>As we’ll see below, a key quantity of interest will be the treatment assignment probability, or <strong>propensity score</strong> <span class="math notranslate nohighlight">\(e(X_i) := \mathbb{P}[W_i = 1 | X_i]\)</span>. In an experimental setting this quantity is usually known and fixed, and in observational settings it must be estimated from the data. We will often need to assume that the propensity score is bounded away from zero and one. That is, there exists some <span class="math notranslate nohighlight">\(\eta &gt; 0\)</span> such that</p>
<div class="math notranslate nohighlight" id="equation-overlap">
<span class="eqno">(7.4)<a class="headerlink" href="#equation-overlap" title="Permalink to this equation">#</a></span>\[
  \eta &lt; e(x) &lt; 1 - \eta  \qquad \text{for all }x.
\]</div>
<p>This assumption is known as <strong>overlap</strong>, and it means that for all types of people in our population (i.e., all values of observable characteristics) we can find some portion of individuals in treatment and some in control. Intuitively, this is necessary because we’d like to will be comparing treatment and control at each level of the covariates and then aggregate those results.</p>
<p>As a running example, in what follows we’ll be using an abridged version of a public dataset from the General Social Survey (GSS) <a class="reference external" href="https://gss.norc.org/Documents/reports/project-reports/GSSProject%20report32.pdf">(Smith, 2016)</a>. The setting is a randomized control trial. Individuals were asked about their thoughts on government spending on the social safety net. The treatment is the wording of the question: about half of the individuals were asked if they thought government spends too much on “welfare” <span class="math notranslate nohighlight">\((W_i = 1)\)</span>, while the remaining half was asked about “assistance to the poor” <span class="math notranslate nohighlight">\((W_i = 0)\)</span>. The outcome is binary, with <span class="math notranslate nohighlight">\(Y_i = 1\)</span> corresponding to a positive answer. In the data set below, we also collect a few other demographic covariates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Treatment: does the the gov&#39;t spend too much on &quot;welfare&quot; (1) or &quot;assistance to the poor&quot; (0)</span>
<span class="n">treatment</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span>

<span class="c1"># Outcome: 1 for &#39;yes&#39;, 0 for &#39;no&#39;</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>

<span class="c1"># Additional covariates</span>
<span class="n">covariates</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;polviews&quot;</span><span class="p">,</span> <span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="s2">&quot;educ&quot;</span><span class="p">,</span> <span class="s2">&quot;marital&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="difference-in-means-estimator">
<h3><span class="section-number">7.2.2. </span>Difference-in-means estimator<a class="headerlink" href="#difference-in-means-estimator" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only valid in the randomized setting. Do not use in observational settings.</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">outcome</span> <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">treatment</span> <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">ate_est</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ate_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="p">))</span>
<span class="n">ate_tstat</span> <span class="o">=</span> <span class="n">ate_est</span> <span class="o">/</span> <span class="n">ate_se</span>
<span class="n">ate_pvalue</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">ate_est</span> <span class="o">/</span> <span class="n">ate_se</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">ate_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;estimate&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">ate_est</span><span class="p">],</span> 
               <span class="s2">&quot;std_error&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">ate_se</span><span class="p">],</span> 
               <span class="s2">&quot;t_stat&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">ate_tstat</span><span class="p">],</span> 
               <span class="s2">&quot;pvalue&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">ate_pvalue</span><span class="p">]</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">ate_results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-2bdfe4a1-3a66-4f17-a73d-dc09f3df129f">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>estimate</th>
      <th>std_error</th>
      <th>t_stat</th>
      <th>pvalue</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.380113</td>
      <td>0.004742</td>
      <td>-80.159075</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-2bdfe4a1-3a66-4f17-a73d-dc09f3df129f')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>

  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-2bdfe4a1-3a66-4f17-a73d-dc09f3df129f button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-2bdfe4a1-3a66-4f17-a73d-dc09f3df129f');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
</div></div>
</div>
<p>And this are the results from original data in chapter 3.</p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>estimate</th>
      <th>std_error</th>
      <th>t_stat</th>
      <th>pvalue</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.347116</td>
      <td>0.004896</td>
      <td>-70.903029</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table><p>We can also compute the same quantity via linear regression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do not use! standard errors are not robust to heteroskedasticity! (See below)</span>
<span class="n">fmla</span> <span class="o">=</span> <span class="n">outcome</span> <span class="o">+</span> <span class="s2">&quot;~&quot;</span> <span class="o">+</span> <span class="n">treatment</span>
<span class="n">ols</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span> <span class="n">fmla</span><span class="p">,</span> <span class="n">data</span> <span class="p">)</span>
<span class="n">table1</span> <span class="o">=</span> <span class="n">ols</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary2</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>
<span class="n">table1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">table1</span><span class="p">)</span>
<span class="n">table1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-c589876e-a96a-4dc5-ac3e-ee552571b812">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>w</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Coef.</th>
      <td>-0.380113</td>
    </tr>
    <tr>
      <th>Std.Err.</th>
      <td>0.004548</td>
    </tr>
    <tr>
      <th>t</th>
      <td>-83.582951</td>
    </tr>
    <tr>
      <th>P&gt;|t|</th>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-c589876e-a96a-4dc5-ac3e-ee552571b812')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>

  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-c589876e-a96a-4dc5-ac3e-ee552571b812 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-c589876e-a96a-4dc5-ac3e-ee552571b812');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
</div></div>
</div>
<p>This are the original results</p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>w</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Coef.</th>
      <td>-0.347116</td>
    </tr>
    <tr>
      <th>Std.Err.</th>
      <td>0.004732</td>
    </tr>
    <tr>
      <th>t</th>
      <td>-73.349622</td>
    </tr>
    <tr>
      <th>P&gt;|t|</th>
      <td>0.000000</td>
    </tr>
  </tbody>
</table><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use this instead. Standard errors are heteroskedasticity-robust.</span>
<span class="c1"># Only valid in randomized setting.</span>
<span class="n">fmla</span> <span class="o">=</span> <span class="n">outcome</span> <span class="o">+</span> <span class="s2">&quot;~&quot;</span> <span class="o">+</span> <span class="n">treatment</span>
<span class="n">ols</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span> <span class="n">fmla</span><span class="p">,</span> <span class="n">data</span> <span class="p">)</span>
<span class="n">table2</span> <span class="o">=</span> <span class="n">ols</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">get_robustcov_results</span><span class="p">(</span><span class="n">cov_type</span> <span class="o">=</span> <span class="s2">&quot;HC2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">summary2</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>
<span class="n">table2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">table2</span><span class="p">)</span>
<span class="n">table2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-18dff8b5-eb15-4f53-b22f-f361698501cd">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>w</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Coef.</th>
      <td>-0.380113</td>
    </tr>
    <tr>
      <th>Std.Err.</th>
      <td>0.004742</td>
    </tr>
    <tr>
      <th>t</th>
      <td>-80.159075</td>
    </tr>
    <tr>
      <th>P&gt;|t|</th>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-18dff8b5-eb15-4f53-b22f-f361698501cd')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>

  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-18dff8b5-eb15-4f53-b22f-f361698501cd button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-18dff8b5-eb15-4f53-b22f-f361698501cd');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
</div></div>
</div>
<p>These are the original results</p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>w</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Coef.</th>
      <td>-0.347116</td>
    </tr>
    <tr>
      <th>Std.Err.</th>
      <td>0.004896</td>
    </tr>
    <tr>
      <th>t</th>
      <td>-70.903029</td>
    </tr>
    <tr>
      <th>P&gt;|t|</th>
      <td>0.000000</td>
    </tr>
  </tbody>
</table><p>As we can see, the results with synthetic data are pretty close to the original ones.</p>
</section>
<section id="turning-an-experimental-dataset-into-an-observational-one">
<h3><span class="section-number">7.2.3. </span>Turning an experimental dataset into an observational one<a class="headerlink" href="#turning-an-experimental-dataset-into-an-observational-one" title="Permalink to this headline">#</a></h3>
<p>In what follows we’ll purposely create a biased sample to show how the difference in means estimator fails in observational settings. We’ll focus on two covariates: <code class="docutils literal notranslate"><span class="pre">age</span></code> and political views (<code class="docutils literal notranslate"><span class="pre">polviews</span></code>). Presumably, younger or more liberal individuals are less affected by the change in wording in the question. So let’s see what happens when we make these individuals more prominent in our sample of treated individuals, and less prominent in our sample of untreated individuals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Probabilistically dropping observations in a manner that depends on x</span>

<span class="c1"># copying old dataset, just in case</span>
<span class="n">data_exp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># defining the group that we will be dropped with some high probability</span>
<span class="n">grp</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">w</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">polviews</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">))</span> <span class="o">|</span> \
        <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="c1"># if untreated AND</span>
        <span class="p">(</span>
            <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">45</span><span class="p">)</span> <span class="o">|</span>   <span class="c1"># belongs a younger group OR</span>
            <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">polviews</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># more liberal</span>
        <span class="p">))</span> 



<span class="n">grp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># Individuals in the group above have a small chance of being kept in the sample</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">0.15</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="kc">True</span> <span class="k">else</span> <span class="mf">0.85</span> <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">keep_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">bool</span><span class="p">,</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span> <span class="mi">1</span> <span class="p">,</span> <span class="n">p</span> <span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prob</span> <span class="p">]</span> <span class="p">)</span>  <span class="p">)</span>

<span class="c1"># Dropping</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="n">keep_idx</span> <span class="p">,</span> <span class="p">:</span> <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;From simulated data set:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keep_idx</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;From original data set:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="mf">0.308030572714899</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>From simulated data set:
0.2925697134680487
From original data set:
0.308030572714899
</pre></div>
</div>
</div>
</div>
<p>Let’s see what happens to our sample before and after the change. This next figure shows the original dataset. Each observation is represented by a point on either the left or right scatterplots. An outcome of <span class="math notranslate nohighlight">\(Y_i=1\)</span> is denoted by a blue circle, and <span class="math notranslate nohighlight">\(Y_i=0\)</span> is denoted by a red square, but let’s not focus on the outcome at the moment. For now, what’s important to note is that the covariate distributions for treated and untreated populations are very similar. This is what we should expect in an experimental setting under unconfoundedness.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y1</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span> <span class="s2">&quot; y ~ 0 + age + polviews&quot;</span> <span class="p">,</span> <span class="n">data_exp</span> <span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;matrix&#39;</span><span class="p">)</span>

<span class="n">W</span> <span class="o">=</span> <span class="n">data_exp</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data_exp</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="mi">1</span> <span class="p">,</span> <span class="mi">2</span> <span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">10</span> <span class="p">,</span> <span class="mi">10</span> <span class="p">)</span> <span class="p">)</span>

<span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">W</span> <span class="o">==</span><span class="n">w</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">W</span> <span class="o">==</span><span class="n">w</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span> <span class="n">w</span> <span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span> 
                    <span class="n">x2</span><span class="p">[</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="n">y2</span><span class="p">[</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="p">,</span> 
                    <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">),</span> 
                    <span class="n">facecolors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
                <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span> <span class="n">w</span> <span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span> 
                    <span class="n">x2</span><span class="p">[</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">y2</span><span class="p">[</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="p">,</span> 
                    <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">),</span> 
                    <span class="n">facecolors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
                <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span> <span class="n">w</span> <span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Age&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span> <span class="n">w</span> <span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Polviews&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span> <span class="n">w</span> <span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Treated&quot;</span> <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;Untreated&quot;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:matplotlib.axes._axes:*c* argument looks like a single numeric RGB or RGBA sequence, which should be avoided as value-mapping will have precedence in case its length matches with *x* &amp; *y*.  Please use the *color* keyword-argument or provide a 2-D array with a single row if you intend to specify the same RGB or RGBA value for all points.
WARNING:matplotlib.axes._axes:*c* argument looks like a single numeric RGB or RGBA sequence, which should be avoided as value-mapping will have precedence in case its length matches with *x* &amp; *y*.  Please use the *color* keyword-argument or provide a 2-D array with a single row if you intend to specify the same RGB or RGBA value for all points.
WARNING:matplotlib.axes._axes:*c* argument looks like a single numeric RGB or RGBA sequence, which should be avoided as value-mapping will have precedence in case its length matches with *x* &amp; *y*.  Please use the *color* keyword-argument or provide a 2-D array with a single row if you intend to specify the same RGB or RGBA value for all points.
WARNING:matplotlib.axes._axes:*c* argument looks like a single numeric RGB or RGBA sequence, which should be avoided as value-mapping will have precedence in case its length matches with *x* &amp; *y*.  Please use the *color* keyword-argument or provide a 2-D array with a single row if you intend to specify the same RGB or RGBA value for all points.
</pre></div>
</div>
<img alt="../_images/8_WGANs_for_simulation_47_1.png" src="../_images/8_WGANs_for_simulation_47_1.png" />
</div>
</div>
<p>On the other hand, this is what the modified dataset looks like. The treated population is much younger and more liberal, while the untreated population is older and more conservative.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y1</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrices</span><span class="p">(</span> <span class="s2">&quot; y ~ 0 + age + polviews&quot;</span> <span class="p">,</span> <span class="n">data</span> <span class="p">,</span> <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;matrix&#39;</span><span class="p">)</span>

<span class="n">W</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="mi">1</span> <span class="p">,</span> <span class="mi">2</span> <span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">10</span> <span class="p">,</span> <span class="mi">10</span> <span class="p">)</span> <span class="p">)</span>

<span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">W</span> <span class="o">==</span><span class="n">w</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">W</span> <span class="o">==</span><span class="n">w</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span> <span class="n">w</span> <span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span> 
                    <span class="n">x2</span><span class="p">[</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="n">y2</span><span class="p">[</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="p">,</span> 
                    <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">),</span> 
                    <span class="n">facecolors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
                <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span> <span class="n">w</span> <span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span> 
                    <span class="n">x2</span><span class="p">[</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">y2</span><span class="p">[</span> <span class="n">Y</span><span class="p">[</span> <span class="n">W</span> <span class="o">==</span> <span class="n">w</span> <span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="p">,</span> 
                    <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">),</span> 
                    <span class="n">facecolors</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>
                <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span> <span class="n">w</span> <span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Age&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span> <span class="n">w</span> <span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Polviews&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span> <span class="n">w</span> <span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;Treated&quot;</span> <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;Untreated&quot;</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:matplotlib.axes._axes:*c* argument looks like a single numeric RGB or RGBA sequence, which should be avoided as value-mapping will have precedence in case its length matches with *x* &amp; *y*.  Please use the *color* keyword-argument or provide a 2-D array with a single row if you intend to specify the same RGB or RGBA value for all points.
WARNING:matplotlib.axes._axes:*c* argument looks like a single numeric RGB or RGBA sequence, which should be avoided as value-mapping will have precedence in case its length matches with *x* &amp; *y*.  Please use the *color* keyword-argument or provide a 2-D array with a single row if you intend to specify the same RGB or RGBA value for all points.
WARNING:matplotlib.axes._axes:*c* argument looks like a single numeric RGB or RGBA sequence, which should be avoided as value-mapping will have precedence in case its length matches with *x* &amp; *y*.  Please use the *color* keyword-argument or provide a 2-D array with a single row if you intend to specify the same RGB or RGBA value for all points.
WARNING:matplotlib.axes._axes:*c* argument looks like a single numeric RGB or RGBA sequence, which should be avoided as value-mapping will have precedence in case its length matches with *x* &amp; *y*.  Please use the *color* keyword-argument or provide a 2-D array with a single row if you intend to specify the same RGB or RGBA value for all points.
</pre></div>
</div>
<img alt="../_images/8_WGANs_for_simulation_49_1.png" src="../_images/8_WGANs_for_simulation_49_1.png" />
</div>
</div>
<p>As we would expect the difference-in-means estimate is biased toward zero because in this new dataset we mostly treated individuals for which we expect the effect to be smaller.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do not use in observational settings.</span>
<span class="c1"># This is only to show how the difference-in-means estimator is biased in that case.</span>
<span class="n">fmla</span> <span class="o">=</span> <span class="n">outcome</span> <span class="o">+</span> <span class="s2">&quot;~&quot;</span> <span class="o">+</span> <span class="n">treatment</span>
<span class="n">ols</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span> <span class="n">fmla</span><span class="p">,</span> <span class="n">data</span> <span class="p">)</span>
<span class="n">ols</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">get_robustcov_results</span><span class="p">(</span><span class="n">cov_type</span> <span class="o">=</span> <span class="s2">&quot;HC2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">summary2</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-54d0c48c-836c-4828-9150-7a8e1cc5a15f">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef.</th>
      <th>Std.Err.</th>
      <th>t</th>
      <th>P&gt;|t|</th>
      <th>[0.025</th>
      <th>0.975]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Intercept</th>
      <td>0.410729</td>
      <td>0.007122</td>
      <td>57.666698</td>
      <td>0.000000e+00</td>
      <td>0.396767</td>
      <td>0.424691</td>
    </tr>
    <tr>
      <th>w</th>
      <td>-0.320450</td>
      <td>0.008572</td>
      <td>-37.383068</td>
      <td>5.000201e-283</td>
      <td>-0.337253</td>
      <td>-0.303646</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-54d0c48c-836c-4828-9150-7a8e1cc5a15f')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>

  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-54d0c48c-836c-4828-9150-7a8e1cc5a15f button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-54d0c48c-836c-4828-9150-7a8e1cc5a15f');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
</div></div>
</div>
<p>These are the results with the original data</p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef.</th>
      <th>Std.Err.</th>
      <th>t</th>
      <th>P&gt;|t|</th>
      <th>[0.025</th>
      <th>0.975]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Intercept</th>
      <td>0.409383</td>
      <td>0.007198</td>
      <td>56.876238</td>
      <td>0.000000e+00</td>
      <td>0.395274</td>
      <td>0.423492</td>
    </tr>
    <tr>
      <th>w</th>
      <td>-0.292019</td>
      <td>0.008759</td>
      <td>-33.337688</td>
      <td>1.254523e-229</td>
      <td>-0.309189</td>
      <td>-0.274848</td>
    </tr>
  </tbody>
</table><p>Note that the dataset created above still satisfies unconfoundedness (3.3), since discrepancies in treatment assignment probability are described by observable covariates (<code class="docutils literal notranslate"><span class="pre">age</span></code> and <code class="docutils literal notranslate"><span class="pre">polviews</span></code>). Moreover, it also satisfies the overlap assumption (3.4), since never completely dropped all treated or all untreated observations in any region of the covariate space. This is important because, in what follows, we’ll consider different estimators of the ATE that are available in observational settings under unconfoundedness and overlap.</p>
</section>
<section id="direct-estimation">
<h3><span class="section-number">7.2.4. </span>Direct estimation<a class="headerlink" href="#direct-estimation" title="Permalink to this headline">#</a></h3>
<p>Our first estimator is suggested by the following decomposition of the ATE, which is possible due to unconfoundedness (3.3).</p>
<div class="amsmath math notranslate nohighlight" id="equation-2a97425b-bd8a-4e65-afd6-6a681f461e3c">
<span class="eqno">(7.5)<a class="headerlink" href="#equation-2a97425b-bd8a-4e65-afd6-6a681f461e3c" title="Permalink to this equation">#</a></span>\[\begin{equation}
  \mathbf{E}[Y_i(1) - Y_i(0)]
  = \mathbf{E}[\mathbf{E}[Y_i | X_i, W_i=1]] - \mathbf{E}[\mathbf{E}[Y_i | X_i, W_i=0]]
\end{equation}\]</div>
<font size=1>
[Exercise: make sure you understand this. Where is the unconfoundedness assumption used?]
</font>
<p>The decomposition above suggests the following procedure, sometimes called the <strong>direct estimate</strong> of the ATE:</p>
<ol class="simple">
<li><p>Estimate <span class="math notranslate nohighlight">\(\mu(x, w) := \mathbf{E}[Y_i|X_i = x,W_i=w]\)</span>, preferably using nonparametric methods.</p></li>
<li><p>Predict <span class="math notranslate nohighlight">\(\hat{\mu}(X_i, 1)\)</span> and <span class="math notranslate nohighlight">\(\hat{\mu}(X_i, 0)\)</span> for each observation in the data.</p></li>
<li><p>Average out the predictions and subtract them.</p></li>
</ol>
<div class="amsmath math notranslate nohighlight" id="equation-46d87447-d8a4-4a8d-a2a3-3401ee8b43fc">
<span class="eqno">(7.6)<a class="headerlink" href="#equation-46d87447-d8a4-4a8d-a2a3-3401ee8b43fc" title="Permalink to this equation">#</a></span>\[\begin{equation}
  \hat{\tau}^{DM} := \frac{1}{n} \sum_{i=1}^{n} \hat{\mu}(X_i, 1) - \hat{\mu}(X_i, 0)
\end{equation}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do not use! We&#39;ll see a better estimator below.</span>
<span class="c1"># Fitting some model of E[Y|X,W]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;y ~ bs(age, df = 3) * w + bs(polviews, df = 3) * w + bs(income, df = 3) * w + bs(educ, df = 3) * w + bs(marital, df = 3) * w + bs(sex, df = 3) * w&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">data_aux</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Predicting E[Y|X,W=w] for w in {0, 1}</span>
<span class="n">data_1</span> <span class="o">=</span> <span class="n">data_aux</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">treatment</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">data_0</span> <span class="o">=</span> <span class="n">data_aux</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data_0</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">treatment</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">muhat_treat</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">data_1</span> <span class="p">)</span> 
<span class="n">muhat_ctrl</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">data_0</span> <span class="p">)</span>

<span class="c1"># Averaging predictions and taking their difference</span>
<span class="n">ate_est</span> <span class="o">=</span> <span class="n">muhat_treat</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">muhat_ctrl</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;From simulated data set:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ate_est</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;From original data set:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3620616673829665</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>From simulated data set:
-0.38409155613997537
From original data set:
-0.3620616673829665
</pre></div>
</div>
</div>
</div>
<p>This estimator allows us to leverage regression techniques to estimate the ATE, so the resulting estimate should have smaller root-mean-squared error. However, it has several disadvantages that make it undesirable. First, its properties will rely heavily on the model  <span class="math notranslate nohighlight">\(\hat{\mu}(x, w)\)</span> being correctly specified: it will be an unbiased and/or consistent estimate of the ATE provided that <span class="math notranslate nohighlight">\(\hat{\mu}(x, w)\)</span>  is an unbiased and/or consistent estimator of  <span class="math notranslate nohighlight">\(\mathbf{E}[Y|X=x, W=w]\)</span>. In practice, having a well-specified model is not something we want to rely upon. In general, it will also not be asymptotically normal, which means that we can’t easily compute t-statistics and p-values for it.</p>
<p>A technical note. Step 1 above can be done by regressing <span class="math notranslate nohighlight">\(Y_i\)</span> on <span class="math notranslate nohighlight">\(X_i\)</span> using only treated observations to get an estimate <span class="math notranslate nohighlight">\(\hat{\mu}(x, 1)\)</span> first, and then repeating the same to obtain <span class="math notranslate nohighlight">\(\hat{\mu}(x, 0)\)</span> from the control observations. Or it can be done by regression <span class="math notranslate nohighlight">\(Y_i\)</span> on both covariates <span class="math notranslate nohighlight">\((X_i, W_i)\)</span> together and obtaining a function <span class="math notranslate nohighlight">\(\hat{\mu}(x, w)\)</span>. Both have advantages and disadvantages, and we refer to <a class="reference external" href="https://www.pnas.org/content/116/10/4156.short">Künzel, Sekhon, Bickel, Yu  (2019)</a> for a discussion.</p>
</section>
<section id="inverse-propensity-weighted-estimator">
<h3><span class="section-number">7.2.5. </span>Inverse propensity-weighted estimator<a class="headerlink" href="#inverse-propensity-weighted-estimator" title="Permalink to this headline">#</a></h3>
<p>To understand this estimator, let’s first consider a toy problem. Suppose that we’d like to estimate the average effect of a certain learning intervention on students’ grades, measured on a scale of 0-100. We run two separate experiments in schools of type A and B. Suppose that, unknown to us, grades among treated students in schools of type A are approximately distributed as <span class="math notranslate nohighlight">\(Y_i(1) | A \sim N(60, 5^2)\)</span>, whereas in schools of type B they are distributed as <span class="math notranslate nohighlight">\(Y_i(1) | B \sim N(70, 5^2)\)</span>. Moreover, for simplicity both schools have the same number of students. If we could treat the same number of students in both types of schools, we’d get an unbiased estimate of the population mean grade among treated individuals: <span class="math notranslate nohighlight">\((1/2)60 + (1/2)70 = 75\)</span>.</p>
<p>However, suppose that enrollment in the treatment is voluntary. In school A, only 5% enroll in the study, whereas in school B the number is 40%. Therefore, if we take an average of treated students’ grades without taking school membership into account, school B’s students would be over-represented, and therefore our estimate of treated student’s grades would be biased upward.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulating the scenario above a large number of times</span>
<span class="n">A_mean</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">B_mean</span> <span class="o">=</span> <span class="mi">70</span>
<span class="n">pop_mean</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">A_mean</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">B_mean</span>  <span class="c1"># both schools have the same size</span>

<span class="c1"># simulating the scenario about a large number of times</span>
<span class="k">def</span> <span class="nf">mean_school</span><span class="p">():</span>
    <span class="n">school</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span> <span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>

    <span class="n">t_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span> <span class="mi">1</span> <span class="p">,</span> <span class="mf">0.05</span> <span class="p">,</span> <span class="mi">100</span> <span class="p">)</span>
    <span class="n">t_false</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span> <span class="mi">1</span> <span class="p">,</span> <span class="mf">0.4</span> <span class="p">,</span> <span class="mi">100</span> <span class="p">)</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span> <span class="n">school</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">school</span><span class="o">.</span><span class="n">size</span> <span class="p">):</span>
        <span class="k">if</span> <span class="n">school</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
            <span class="n">treated</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">t_true</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">treated</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">t_false</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span>

    <span class="n">g_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">A_mean</span> <span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">100</span> <span class="p">)</span>
    <span class="n">g_false</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">B_mean</span> <span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">100</span> <span class="p">)</span>
    <span class="n">grades</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span> <span class="n">school</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">school</span><span class="o">.</span><span class="n">size</span> <span class="p">):</span>
        <span class="k">if</span> <span class="n">school</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
            <span class="n">grades</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">g_true</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grades</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">g_false</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span>    

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">grades</span><span class="p">[</span> <span class="n">treated</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span>

<span class="n">sample_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mean_school</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1000</span> <span class="p">)])</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="mi">1</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">10</span> <span class="p">,</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span> <span class="n">sample_means</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">75</span> <span class="p">])</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span> <span class="s2">&quot;Sample means of treated students&#39; grades&quot;</span> <span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span> <span class="n">pop_mean</span> <span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dashed&quot;</span> <span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;truth&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f008036edd0&gt;
</pre></div>
</div>
<img alt="../_images/8_WGANs_for_simulation_58_1.png" src="../_images/8_WGANs_for_simulation_58_1.png" />
</div>
</div>
<p>This is the graph of the original data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Read and show image</span>
<span class="n">url1</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/d2cml-ai/mgtecon634_py/main/figs/fig_1.png&quot;</span>
<span class="n">req1</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url1</span><span class="p">)</span>
<span class="n">im1</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">req1</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="n">im1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8_WGANs_for_simulation_60_0.png" src="../_images/8_WGANs_for_simulation_60_0.png" />
</div>
</div>
<p>To solve this problem, we can consider each school separately, and then aggregate the results. Denote by <span class="math notranslate nohighlight">\(n_A\)</span> the number of students from school <span class="math notranslate nohighlight">\(A\)</span>, and <span class="math notranslate nohighlight">\(n_{A,1}\)</span> denote the number of treated students in that school. Likewise, denote by <span class="math notranslate nohighlight">\(n_B\)</span> and <span class="math notranslate nohighlight">\(n_{B,1}\)</span> the same quantities for school <span class="math notranslate nohighlight">\(B\)</span>. Then our aggregated means estimator can be written as:</p>
<div class="math notranslate nohighlight" id="equation-agg">
<span class="eqno">(7.7)<a class="headerlink" href="#equation-agg" title="Permalink to this equation">#</a></span>\[\begin{split} 
  \overbrace{
  {\left (\frac{n_{A}}{n} \right)}
  }^{\text{Proportion of A}}
  \underbrace{
  \frac{1}{n_{A, 1}} \sum_{\substack{i \in A \\ i \text{ treated}}} Y_i
  }_{\text{avg. among treated in A}}
  +
 \overbrace{
 {\left (\frac{n_{B}}{n} \right)}
 }^{\text{Proportion of B}}
 \underbrace{
  \frac{1}{n_{B, 1}} \sum_{\substack{i \in B \\ i \text{ treated}}} Y_i
  }_{\text{avg. among treated in B}}.
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simulating the scenario about a large number of times</span>
<span class="k">def</span> <span class="nf">agg_mean_school</span><span class="p">():</span>
    <span class="n">school</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span> <span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>

    <span class="n">t_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span> <span class="mi">1</span> <span class="p">,</span> <span class="mf">0.05</span> <span class="p">,</span> <span class="mi">100</span> <span class="p">)</span>
    <span class="n">t_false</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span> <span class="mi">1</span> <span class="p">,</span> <span class="mf">0.4</span> <span class="p">,</span> <span class="mi">100</span> <span class="p">)</span>
    <span class="n">treated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span> <span class="n">school</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">school</span><span class="o">.</span><span class="n">size</span> <span class="p">):</span>
        <span class="k">if</span> <span class="n">school</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
            <span class="n">treated</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">t_true</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">treated</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">t_false</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span>

    <span class="n">g_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">A_mean</span> <span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">100</span> <span class="p">)</span>
    <span class="n">g_false</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">B_mean</span> <span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">100</span> <span class="p">)</span>
    <span class="n">grades</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span> <span class="n">school</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="n">school</span><span class="o">.</span><span class="n">size</span> <span class="p">):</span>
        <span class="k">if</span> <span class="n">school</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
            <span class="n">grades</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">g_true</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grades</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">g_false</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span>
            
    <span class="n">mean_treated_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">grades</span><span class="p">[(</span><span class="n">treated</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">school</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">)])</span>
    <span class="n">mean_treated_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">grades</span><span class="p">[(</span><span class="n">treated</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">school</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span><span class="p">)])</span>
    <span class="c1"># probability of belonging to each school</span>
    <span class="n">prob_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">school</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="n">prob_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">school</span> <span class="o">==</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">prob_A</span> <span class="o">*</span> <span class="n">mean_treated_A</span> <span class="o">+</span> <span class="n">prob_B</span> <span class="o">*</span> <span class="n">mean_treated_B</span>
    
    <span class="k">return</span> <span class="n">result</span>

<span class="n">agg_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">agg_mean_school</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">1000</span> <span class="p">)])</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span> <span class="mi">1</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">10</span> <span class="p">,</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span> <span class="n">agg_means</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">75</span> <span class="p">])</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span> <span class="s2">&quot;Aggregated sample means of treated students&#39; grades&quot;</span> <span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span> <span class="n">pop_mean</span> <span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dashed&quot;</span> <span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;truth&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f63fbdd09d0&gt;
</pre></div>
</div>
<img alt="../_images/8_WGANs_for_simulation_62_1.png" src="../_images/8_WGANs_for_simulation_62_1.png" />
</div>
</div>
<p>This is the graph of the original data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Read and show image</span>
<span class="n">url2</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/d2cml-ai/mgtecon634_py/main/figs/fig_2.png&quot;</span>
<span class="n">req2</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url2</span><span class="p">)</span>
<span class="n">im2</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">req2</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="n">im2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8_WGANs_for_simulation_64_0.png" src="../_images/8_WGANs_for_simulation_64_0.png" />
</div>
</div>
<p>Next, we’ll manipulate the expression <a class="reference internal" href="#equation-agg">(7.7)</a>. This next derivation can be a bit overwhelming, but please keep in mind that we’re simply doing algebraic manipulations, as well as establishing some common and useful notation. First, note that we can rewrite the average for school A in <a class="reference internal" href="#equation-agg">(7.7)</a> as</p>
<div class="math notranslate nohighlight" id="equation-avg1">
<span class="eqno">(7.8)<a class="headerlink" href="#equation-avg1" title="Permalink to this equation">#</a></span>\[\begin{split}
    \left (\frac{1}{n_{A, 1}}\right) 
    \sum_{\substack{i \in A \\ i \text{ treated}}} Y_i
    =
    \frac{1}{n_A} \sum_{\substack{i \in A \\ i \text{ treated}}} \frac{1}{(n_{A,1} / n_A)} Y_i
    =
    \frac{1}{n_A} \sum_{i \in A} \frac{W_i}{(n_{A,1} / n_A)} Y_i,
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(W_i\)</span> is the treatment indicator. Plugging <a class="reference internal" href="#equation-avg1">(7.8)</a> back into <a class="reference internal" href="#equation-agg">(7.7)</a>,</p>
<div class="math notranslate nohighlight">
\[
  \left ({\frac{n_{A}}{n}}\right) 
    \frac{1}{n_A} \sum_{i \in A} \frac{W_i}{(n_{A,1} / n_A)} Y_i
  +
 \left ({\frac{n_{B}}{n}}\right) 
\frac{1}{n_B} \sum_{i \in B} \frac{W_i}{(n_{B,1} / n_B)} Y_i.
\]</div>
<p>Note that the <span class="math notranslate nohighlight">\(n_A\)</span> and <span class="math notranslate nohighlight">\(n_B\)</span> will cancel out. Finally, if we denote the sample proportion of treated students in school <span class="math notranslate nohighlight">\(A\)</span> by <span class="math notranslate nohighlight">\(\hat{e}(A_i) \approx n_{A,1}/n_A\)</span> and similar for school <span class="math notranslate nohighlight">\(B\)</span>, <a class="reference internal" href="#equation-agg">(7.7)</a> can be written compactly as</p>
<div class="math notranslate nohighlight" id="equation-ipw-treated">
<span class="eqno">(7.9)<a class="headerlink" href="#equation-ipw-treated" title="Permalink to this equation">#</a></span>\[
  \frac{1}{n} \sum_{i=1}^{n}  \frac{W_i}{\hat{e}(X_i)} Y_i,
\]</div>
<p>where <span class="math notranslate nohighlight">\(X_i \in \{A, B\}\)</span> denotes the school membership. Quantity <span class="math notranslate nohighlight">\(\hat{e}(X_i)\)</span> is an estimate of the probability of treatment given the control variable <span class="math notranslate nohighlight">\(e(X_i) = \mathbb{P}[W_i=1 | X_i ]\)</span>, also called the <strong>propensity score</strong>. Because <a class="reference internal" href="#equation-ipw-treated">(7.9)</a> is a weighted average with weights <span class="math notranslate nohighlight">\(W_i/\hat{e}(X_i)\)</span>, when written in this form we say that it is an <strong>inverse propensity-weighted estimator</strong> (IPW).</p>
<p>The IPW estimator is also defined for the case of continuous covariates. In that case, we must estimate the assignment probability given some model, for example using logistic regression, forests, etc. With respect to modeling, the behavior of the IPW estimator is similar to the direct estimator: if <span class="math notranslate nohighlight">\(\hat{e}(X_i)\)</span> is an unbiased estimate of <span class="math notranslate nohighlight">\(e(X_i)\)</span>, then <a class="reference internal" href="#equation-ipw-treated">(7.9)</a> is an unbiased estimate of <span class="math notranslate nohighlight">\(E[Y(1)]\)</span>; and we can show that if <span class="math notranslate nohighlight">\(\hat{e}(X_i)\)</span> is a consistent estimator of <span class="math notranslate nohighlight">\(e(X_i)\)</span>, then <a class="reference internal" href="#equation-ipw-treated">(7.9)</a> is consistent for <span class="math notranslate nohighlight">\(E[Y(1)]\)</span>.</p>
<p>Another important point is that when the estimated treatment propensity <span class="math notranslate nohighlight">\(\hat{e}(X_i)\)</span> is small, the summands in <a class="reference internal" href="#equation-ipw-treated">(7.9)</a> can be very large. In particular, if <span class="math notranslate nohighlight">\(\hat{e}(x)\)</span> is exactly zero, then this estimator is undefined. That is why, in addition to requiring conditional unconfoundedness <a class="reference internal" href="#equation-unconf-1">(7.3)</a>, it also requires the overlap condition <a class="reference internal" href="#equation-overlap">(7.4)</a>. In any case, when overlap is small (i.e., <span class="math notranslate nohighlight">\(\hat{e}(x)\)</span> is very close to zero for many <span class="math notranslate nohighlight">\(x\)</span>), IPW becomes an unattractive estimator due to its high variance. We’ll see in the next section an improved estimator that builds upon IPW but is strictly superior and should be used instead.</p>
<p>Finally, we just derived an estimator of the average treated outcome, but we could repeat the argument for control units instead. Subtracting the two estimators leads to the following inverse propensity-weighted estimate of the treatment effect:</p>
<div class="math notranslate nohighlight">
\[
  \widehat{\tau}^{IPW} := \frac{1}{n} \sum_{i=1}^{n} Y_i \frac{W_i}{\hat{e}(X_i)} - \frac{1}{n} \sum_{i=1}^{n} Y_i \frac{(1 - W_i) }{1-\hat{e}(X_i)}.
\]</div>
<p>The argument above suggests the following algorithm:</p>
<ol class="simple">
<li><p>Estimate the propensity scores <span class="math notranslate nohighlight">\(e(X_i)\)</span> by regressing <span class="math notranslate nohighlight">\(W_i\)</span> on <span class="math notranslate nohighlight">\(X_i\)</span>, preferably using a non-parametric method.</p></li>
<li><p>Compute the IPW estimator summand:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[Z_i = Y_i \times \left(\frac{W_i}{\hat{e}(X_i)} - \frac{(1-W_i)}{(1-\hat{e}(X_i)} \right)\]</div>
<ol class="simple">
<li><p>Compute the mean and standard error of the new variable <span class="math notranslate nohighlight">\(Z_i\)</span></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LassoCV</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">RidgeCV</span><span class="p">,</span> <span class="n">ElasticNetCV</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_string_dtype</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_numeric_dtype</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_categorical_dtype</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">compress</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">SelectFromModel</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">standard_skl_model</span><span class="p">:</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
       
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="p">):</span>
        
        <span class="c1"># Standarization of X and Y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">X</span> <span class="p">)</span>
        <span class="n">std_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span> <span class="n">X</span> <span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">std_X</span> <span class="p">,</span> <span class="n">Y</span> <span class="p">)</span>
                
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span> <span class="bp">self</span> <span class="p">,</span> <span class="n">X</span> <span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> <span class="n">X</span> <span class="p">)</span>
        <span class="n">std_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_X</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span> <span class="n">X</span> <span class="p">)</span>
        
        <span class="n">prediction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">std_X</span> <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">prediction</span>
</pre></div>
</div>
</div>
</div>
<p>Differences between the type responde in glmnet. The response input gives as probabilities while class give us the labels for the observations.</p>
<p>Differences between cv.glmnet and Sklearn <a class="reference external" href="https://github.com/scikit-learn/scikit-learn/issues/6595">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegressionCV</span>

<span class="n">fmla</span> <span class="o">=</span> <span class="s2">&quot;bs(age, df = 3) + bs(polviews, df = 3) + bs(income, df = 3) +  bs(educ, df = 3) + bs(marital, df = 3) + bs(sex, df = 3)&quot;</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span><span class="n">treatment</span><span class="p">]</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span><span class="n">outcome</span><span class="p">]</span>
<span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span> <span class="n">fmla</span><span class="p">,</span> <span class="n">data</span> <span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Available in randomized settings and observational settings with unconfoundedness+overlap</span>

<span class="c1"># Estimate the propensity score e(X) via logistic regression using splines</span>
<span class="n">logit</span> <span class="o">=</span> <span class="n">standard_skl_model</span><span class="p">(</span> <span class="n">LogisticRegressionCV</span><span class="p">(</span>  <span class="n">cv</span><span class="o">=</span> <span class="mi">10</span> <span class="p">,</span> <span class="n">penalty</span> <span class="o">=</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span> 
                                                   <span class="n">random_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
                                                   <span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;newton-cg&quot;</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span> 
                    <span class="n">XX</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>

<span class="n">prob</span> <span class="o">=</span> <span class="n">logit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span> <span class="n">XX</span> <span class="p">)</span>

<span class="n">e_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span>  <span class="n">np</span><span class="o">.</span><span class="n">max</span> <span class="p">,</span> <span class="mi">1</span>  <span class="p">,</span> <span class="n">prob</span> <span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using the fact that</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="n">W</span> <span class="o">/</span> <span class="n">e_hat</span> <span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="p">(</span> <span class="mi">1</span><span class="o">-</span> <span class="n">W</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">e_hat</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

<span class="n">ate_est</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ate_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">z</span><span class="o">.</span><span class="n">var</span><span class="p">())</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
<span class="n">ate_tstat</span> <span class="o">=</span> <span class="n">ate_est</span> <span class="o">/</span> <span class="n">ate_se</span>
<span class="n">ate_pvalue</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span> <span class="n">ate_est</span> <span class="o">/</span> <span class="n">ate_se</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">ate_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;estimate&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">ate_est</span><span class="p">],</span> 
               <span class="s2">&quot;std_error&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">ate_se</span><span class="p">],</span> 
               <span class="s2">&quot;t_stat&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">ate_tstat</span><span class="p">],</span> 
               <span class="s2">&quot;pvalue&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="n">ate_pvalue</span><span class="p">]</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">ate_results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-ca8f2bf0-b3ae-4a85-832d-f64bb5868b01">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>estimate</th>
      <th>std_error</th>
      <th>t_stat</th>
      <th>pvalue</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.717084</td>
      <td>0.016164</td>
      <td>-44.363725</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-ca8f2bf0-b3ae-4a85-832d-f64bb5868b01')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>

  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-ca8f2bf0-b3ae-4a85-832d-f64bb5868b01 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-ca8f2bf0-b3ae-4a85-832d-f64bb5868b01');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
</div></div>
</div>
<p>Results from the original data</p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>estimate</th>
      <th>std_error</th>
      <th>t_stat</th>
      <th>pvalue</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.413384</td>
      <td>0.011955</td>
      <td>-34.57801</td>
      <td>3.513410e-247</td>
    </tr>
  </tbody>
</table></section>
</section>
<section id="augmented-inverse-propensity-weighted-aipw-estimator">
<h2><span class="section-number">7.3. </span>Augmented inverse propensity-weighted (AIPW) estimator<a class="headerlink" href="#augmented-inverse-propensity-weighted-aipw-estimator" title="Permalink to this headline">#</a></h2>
<p>The next <strong>augmented inverse propensity-weighted estimator</strong> (AIPW) of the treatment effect is available under unconfoundedness <a class="reference internal" href="#equation-unconf-1">(7.3)</a> and overlap <a class="reference internal" href="#equation-overlap">(7.4)</a>:</p>
<div class="math notranslate nohighlight" id="equation-aipw">
<span class="eqno">(7.10)<a class="headerlink" href="#equation-aipw" title="Permalink to this equation">#</a></span>\[\begin{split}
  \begin{aligned}
  \hat{\tau}^{AIPW} &amp;:=
    \frac{1}{n} \sum_{i=1}^{n}
      \hat{\mu}^{-i}(X_i, 1) - \hat{\mu}^{-i}(X_i, 0) \\
      &amp;+
      \frac{W}{\hat{e}^{-i}(X_i)}  \left ({ Y_i - \hat{\mu}^{-i}(X_i, 1)} \right)
      -
      \frac{1-W}{1-\hat{e}^{-i}(X_i)}  \left ({ Y_i - \hat{\mu}^{-i}(X_i, 0)} \right)
    \end{aligned}
\end{split}\]</div>
<p>Let’s parse <a class="reference internal" href="#equation-aipw">(7.10)</a>. Ignoring the superscripts for now, the first two terms correspond to an estimate of the treatment effect obtained via direct estimation. The next two terms resemble the IPW estimator, except that we replaced the outcome <span class="math notranslate nohighlight">\(Y_i\)</span> with the residuals <span class="math notranslate nohighlight">\(Y_i - \hat{\mu}(X_i, W_i)\)</span>. At a high level, the last two terms estimate and subtract an estimate of the bias of the first.</p>
<p>The superscripts have to do with a technicality called <strong>cross-fitting</strong> that is required to prevent a specific form of overfitting and allow certain desirable asymptotic properties to hold. That is, we need to fit the outcome and propensity models using one portion of the data, and compute predictions on the remaining portion. An easy way of accomplishing this is to divide the data into K folds, and then estimate <span class="math notranslate nohighlight">\(K\)</span> models that are fitted on <span class="math notranslate nohighlight">\(K-1\)</span> folds, and then compute predictions on the remaining Kth fold. The example below does that with <span class="math notranslate nohighlight">\(K=5\)</span>. Note that this is different from cross-validation: the goal of cross-validation is to obtain accurate estimates of the loss function for model selection, whereas the goal of cross-fitting is simply to not use the same observation to fit the model and produce predictions.</p>
<p>The AIPW estimator <a class="reference internal" href="#equation-aipw">(7.10)</a> has several desirable properties. First, it will be unbiased provided that either <span class="math notranslate nohighlight">\(\hat{\mu}(X_i, w)\)</span> or <span class="math notranslate nohighlight">\(\hat{e}(X_i, w)\)</span> is unbiased. Second, it will be consistent provided that either  <span class="math notranslate nohighlight">\(\hat{\mu}(X_i, w)\)</span> or <span class="math notranslate nohighlight">\(\hat{e}(X_i, w)\)</span> is consistent. This property is called <strong>double robustness (DR)</strong>, because only one of the outcome or propensity score models needs to be correctly specified, so the estimator is “robust” to misspecification in the remaining model. Under mild assumptions, it is also asymptotically normal and it is efficient, that is has the smallest asymptotic variance than any other estimator. In fact, it even has smaller variance than the difference-in-means estimators in the <em>randomized</em> setting and is therefore superior to it.</p>
<p>The next snippet provides an implementation of the AIPW estimator where outcome and propensity models are estimated using generalized linear models with splines (via <code class="docutils literal notranslate"><span class="pre">glmnet</span></code> and <code class="docutils literal notranslate"><span class="pre">splines</span></code> packages).</p>
<p>Here’s another example of AIPW-based estimation using random forests via the package <code class="docutils literal notranslate"><span class="pre">grf</span></code>. The function <code class="docutils literal notranslate"><span class="pre">average_treatment_effect</span></code> computes the AIPW estimate of the treatment effect, and uses forest-based estimates of the outcome model and propensity scores (unless those are passed directly via the arguments <code class="docutils literal notranslate"><span class="pre">Y.hat</span></code> and <code class="docutils literal notranslate"><span class="pre">W.hat</span></code>). Also, because forests are an ensemble method, cross-fitting is accomplished via <a class="reference external" href="https://github.com/grf-labs/grf/blob/master/REFERENCE.md#out-of-bag-prediction"><em>out-of-bag</em></a> predictions – that is, predictions for observation <span class="math notranslate nohighlight">\(i\)</span> are computed using trees that were not constructed using observation <span class="math notranslate nohighlight">\(i\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">econml</span>
<span class="c1"># Main imports</span>
<span class="kn">from</span> <span class="nn">econml.orf</span> <span class="kn">import</span> <span class="n">DMLOrthoForest</span><span class="p">,</span> <span class="n">DROrthoForest</span>
<span class="kn">from</span> <span class="nn">econml.dml</span> <span class="kn">import</span> <span class="n">CausalForestDML</span>
<span class="kn">from</span> <span class="nn">econml.grf</span> <span class="kn">import</span> <span class="n">CausalForest</span>
<span class="kn">from</span> <span class="nn">econml.sklearn_extensions.linear_model</span> <span class="kn">import</span> <span class="n">WeightedLassoCVWrapper</span><span class="p">,</span> <span class="n">WeightedLasso</span><span class="p">,</span> <span class="n">WeightedLassoCV</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">MultiTaskLassoCV</span>
<span class="c1"># Helper imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">LassoCV</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">LogisticRegressionCV</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">econml.grf</span> <span class="kn">import</span> <span class="n">RegressionForest</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">patsy</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fmla</span> <span class="o">=</span> <span class="s1">&#39;age+polviews+income+educ+marital+sex&#39;</span>
<span class="n">desc</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">ModelDesc</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="n">fmla</span><span class="p">)</span>
<span class="n">desc</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">return_type</span> <span class="o">=</span> <span class="s2">&quot;dataframe&quot;</span><span class="p">)</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">]</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">matrix</span>
<span class="n">W</span> <span class="o">=</span> <span class="kc">None</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate a causal forest.</span>
<span class="n">est2</span> <span class="o">=</span> <span class="n">CausalForest</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">max_depth</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

<span class="n">est2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CausalForest(max_depth=50, random_state=123)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get residuals  and propensity </span>

<span class="n">regr</span> <span class="o">=</span> <span class="n">RegressionForest</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
                        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="n">e_hat</span> <span class="o">=</span> <span class="n">regr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># P[W=1|X]</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">regr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># E[Y|X]</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, even when overlap holds, when the propensity score is small AIPW can have unstable performance. In that case, other estimators of the average treatment effect are available. For example, see the <em>approximate residual balancing</em> (ARB) method in <a class="reference external" href="https://arxiv.org/abs/1604.07125">Athey, Imbens and Wager (2016)</a> and its accompanying <code class="docutils literal notranslate"><span class="pre">R</span></code> package <a class="reference external" href="https://github.com/swager/balanceHD"><code class="docutils literal notranslate"><span class="pre">balanceHD</span></code></a>.</p>
<section id="diagnostics">
<h3><span class="section-number">7.3.1. </span>Diagnostics<a class="headerlink" href="#diagnostics" title="Permalink to this headline">#</a></h3>
<p>Here we show some basic diagnostics and best practices that should always be conducted. Although failing these tests should usually cause concern, passing them does not mean that the analysis is entirely free from issues. For example, even if our estimated propensity scores are bounded away from zero and one (and therefore seem to satisfy the overlap assumption), they may still be incorrect – for example, if we rely on modeling assumptions that are simply not true. Also, although we should expect to pass all the diagnostic tests below in randomized settings, it’s good practice to check them anyway, as one may find problems with the experimental design.</p>
</section>
<section id="assessing-balance">
<h3><span class="section-number">7.3.2. </span>Assessing balance<a class="headerlink" href="#assessing-balance" title="Permalink to this headline">#</a></h3>
<p>As we saw in Section (3.3), in observational settings the covariate distributions can be very different for treated and untreated individuals. Such discrepancies can lead to biased estimates of the ATE, but as hinted in Section (3.5), one would hope that by up- or down-weighting observations based on inverse propensity weights their averages should be similar. In fact, we should also expect that averages of basis functions of the covariates should be similar after reweighting. This property is called <strong>balance</strong>. One way to check it is as follows. Given some variable <span class="math notranslate nohighlight">\(Z_i\)</span> (e.g., a covariate <span class="math notranslate nohighlight">\(X_{i1}\)</span>, or an interaction between covariates <span class="math notranslate nohighlight">\(X_{i1}X_{i2}\)</span>, or a polynomial in covariates <span class="math notranslate nohighlight">\(X_{i1}^2\)</span>, etc), we can check the absolute standardized mean difference (ASMD) of <span class="math notranslate nohighlight">\(Z_i\)</span> between treated and untreated individuals in our data,</p>
<div class="math notranslate nohighlight">
\[
  \frac{|\bar{Z}_1 - \bar{Z}_0|}{\sqrt{s_1^2 + s_0^2}},
\]</div>
<p>where <span class="math notranslate nohighlight">\(\bar{Z}_1\)</span> and <span class="math notranslate nohighlight">\(\bar{Z}_0\)</span> are sample averages of <span class="math notranslate nohighlight">\(Z_i\)</span>, and <span class="math notranslate nohighlight">\(s_1\)</span> and <span class="math notranslate nohighlight">\(s_0\)</span> are standard deviations of <span class="math notranslate nohighlight">\(Z_i\)</span> for the two samples of treated and untreated individuals. Next, we can check the same quantity for their weighted counterparts <span class="math notranslate nohighlight">\(Z_{i}W_i/\hat{e}(X_i)\)</span> and <span class="math notranslate nohighlight">\(Z_i(1-W_i)/(1-\hat{e}(X_i))\)</span>. If our propensity scores are well-calibrated, the ASMD for the weighted version should be close to zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Here, adding covariates and their interactions, though there are many other possibilities.</span>
<span class="n">fmla</span> <span class="o">=</span> <span class="s1">&#39;age+polviews+income+educ+marital+sex+age:polviews+age:income+age:educ+age:marital+age:sex+polviews:income+polviews:educ+polviews:marital+polviews:sex+income:educ+income:marital+income:sex+educ:marital+educ:sex+marital:sex&#39;</span>
<span class="n">desc</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">ModelDesc</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="n">fmla</span><span class="p">)</span>
<span class="n">desc</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>

<span class="c1"># Using the propensity score estimated above</span>
<span class="c1">#residuals = est2.fit(Y, T, X=X, W=W, cache_values=True).residuals_</span>
<span class="c1">#T_res = residuals[1]</span>
<span class="c1">#e_hat = T - T_res</span>

<span class="n">regr</span> <span class="o">=</span> <span class="n">RegressionForest</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span>
                        <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="n">e_hat</span> <span class="o">=</span> <span class="n">regr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># P[W=1|X]</span>
<span class="n">m_hat</span> <span class="o">=</span> <span class="n">regr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># E[Y|X]</span>

<span class="n">matrix</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">return_type</span> <span class="o">=</span> <span class="s2">&quot;dataframe&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">]</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
<span class="n">XX</span> <span class="o">=</span> <span class="n">matrix</span>
<span class="n">T</span> <span class="o">=</span> <span class="kc">None</span> 
<span class="n">pp</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Unadjusted covariate means, variances and standardized abs mean differences</span>
<span class="n">means_treat</span> <span class="o">=</span> <span class="n">XX</span><span class="p">[</span><span class="n">W</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">means_ctrl</span> <span class="o">=</span> <span class="n">XX</span><span class="p">[</span><span class="n">W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">abs_mean_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">means_treat</span> <span class="o">-</span> <span class="n">means_ctrl</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

<span class="n">var_treat</span> <span class="o">=</span> <span class="n">XX</span><span class="p">[</span><span class="n">W</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">var_ctrl</span> <span class="o">=</span> <span class="n">XX</span><span class="p">[</span><span class="n">W</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">var_treat</span> <span class="o">+</span> <span class="n">var_ctrl</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adjusted covariate means, variances and standardized abs mean differences</span>
<span class="n">means_treat_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">XX</span><span class="o">*</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">W</span><span class="o">/</span><span class="n">e_hat</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">means_ctrl_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">XX</span><span class="o">*</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">W</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e_hat</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">abs_mean_diff_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">means_treat_adj</span> <span class="o">-</span> <span class="n">means_ctrl_adj</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

<span class="n">var_treat_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">XX</span><span class="o">*</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">W</span><span class="o">/</span><span class="n">e_hat</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">var_ctrl_adj</span> <span class="o">=</span> <span class="p">(</span><span class="n">XX</span><span class="o">*</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">W</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e_hat</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
<span class="n">std_adj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">var_treat_adj</span> <span class="o">+</span> <span class="n">var_ctrl_adj</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create dataframe to make plots </span>
<span class="n">frame</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;abs_mean_diff&#39;</span><span class="p">:</span> <span class="n">abs_mean_diff</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">std</span><span class="p">,</span> <span class="s1">&#39;abs_mean_diff_adj&#39;</span><span class="p">:</span> <span class="n">abs_mean_diff_adj</span><span class="p">,</span> <span class="s1">&#39;std_adj&#39;</span><span class="p">:</span> <span class="n">std_adj</span>  <span class="p">}</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
<span class="n">result</span><span class="p">[</span><span class="s2">&quot;std_abs_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;abs_mean_diff&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span>
<span class="n">result</span><span class="p">[</span><span class="s2">&quot;std_abs_mean_adj&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;abs_mean_diff_adj&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;std_adj&quot;</span><span class="p">]</span>
<span class="n">result</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;vars&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plotting </span>
<span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span> 
<span class="c1">#x = np.arange(0, 10, 1)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;std_abs_mean&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;vars&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;std_abs_mean_adj&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;vars&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Standardized absolute mean differences&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Standardized absolute mean differences&#39;)
</pre></div>
</div>
<img alt="../_images/8_WGANs_for_simulation_87_1.png" src="../_images/8_WGANs_for_simulation_87_1.png" />
</div>
</div>
<p>This is the graph of the original data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Read and show image</span>
<span class="n">url3</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/d2cml-ai/mgtecon634_py/main/figs/fig_3.png&quot;</span>
<span class="n">req3</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url3</span><span class="p">)</span>
<span class="n">im3</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">req3</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="n">im3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8_WGANs_for_simulation_89_0.png" src="../_images/8_WGANs_for_simulation_89_0.png" />
</div>
</div>
<p>Note above how in particular <code class="docutils literal notranslate"><span class="pre">age</span></code> and <code class="docutils literal notranslate"><span class="pre">polviews</span></code> – the variables we chose to introduce imbalance in Section (3.3) – are far from balanced before adjustment, as are other variables that correlate with them.</p>
<p>In addition to the above, we can check the entire distribution of covariates (and their transformations). The next snippet plots histograms for treated and untreated individuals with and without adjustment. Note how the adjusted histograms are very similar – that is what we should expect.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_2</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;polviews&quot;</span><span class="p">,</span> <span class="s2">&quot;age:polviews&quot;</span><span class="p">,</span> <span class="s2">&quot;educ&quot;</span><span class="p">,]]</span>
<span class="c1"># merge covariates and treatment variable  </span>
<span class="n">data_3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_2</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
               <span class="n">left_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">data_3</span><span class="p">[</span><span class="s2">&quot;IPW&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_3</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">e_hat</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e_hat</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Covariate histograms (unajusted)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">data_3</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">data_3</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;polviews&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">data_3</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;age:polviews&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">data_3</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;educ&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x7f6408f91550&gt;
</pre></div>
</div>
<img alt="../_images/8_WGANs_for_simulation_92_1.png" src="../_images/8_WGANs_for_simulation_92_1.png" />
<img alt="../_images/8_WGANs_for_simulation_92_2.png" src="../_images/8_WGANs_for_simulation_92_2.png" />
<img alt="../_images/8_WGANs_for_simulation_92_3.png" src="../_images/8_WGANs_for_simulation_92_3.png" />
<img alt="../_images/8_WGANs_for_simulation_92_4.png" src="../_images/8_WGANs_for_simulation_92_4.png" />
</div>
</div>
<p>This is the graph of the original data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Read and show image</span>
<span class="n">url4</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/d2cml-ai/mgtecon634_py/main/figs/fig_4.png&quot;</span>
<span class="n">req4</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url4</span><span class="p">)</span>
<span class="n">im4</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">req4</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="n">im4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8_WGANs_for_simulation_94_0.png" src="../_images/8_WGANs_for_simulation_94_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Covariate histograms (ajusted)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">data_3</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_3</span><span class="p">[</span><span class="s2">&quot;IPW&quot;</span><span class="p">])</span> <span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">data_3</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;polviews&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_3</span><span class="p">[</span><span class="s2">&quot;IPW&quot;</span><span class="p">])</span> <span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">data_3</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;age:polviews&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_3</span><span class="p">[</span><span class="s2">&quot;IPW&quot;</span><span class="p">])</span> <span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">data_3</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;educ&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_3</span><span class="p">[</span><span class="s2">&quot;IPW&quot;</span><span class="p">])</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x7f63e3a600d0&gt;
</pre></div>
</div>
<img alt="../_images/8_WGANs_for_simulation_95_1.png" src="../_images/8_WGANs_for_simulation_95_1.png" />
<img alt="../_images/8_WGANs_for_simulation_95_2.png" src="../_images/8_WGANs_for_simulation_95_2.png" />
<img alt="../_images/8_WGANs_for_simulation_95_3.png" src="../_images/8_WGANs_for_simulation_95_3.png" />
<img alt="../_images/8_WGANs_for_simulation_95_4.png" src="../_images/8_WGANs_for_simulation_95_4.png" />
</div>
</div>
<p>This is the graph of the original data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Read and show image</span>
<span class="n">url5</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/d2cml-ai/mgtecon634_py/main/figs/fig_5.png&quot;</span>
<span class="n">req5</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url5</span><span class="p">)</span>
<span class="n">im5</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">req5</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="n">im5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8_WGANs_for_simulation_97_0.png" src="../_images/8_WGANs_for_simulation_97_0.png" />
</div>
</div>
<p>There exist other types of balance checks. We recommend checking out the <code class="docutils literal notranslate"><span class="pre">R</span></code> package <code class="docutils literal notranslate"><span class="pre">cobalt</span></code>. This <a class="reference external" href="https://cran.r-project.org/web/packages/cobalt/vignettes/cobalt.html">vignette</a> is a good place to start.</p>
<section id="assessing-overlap">
<h4><span class="section-number">7.3.2.1. </span>Assessing overlap<a class="headerlink" href="#assessing-overlap" title="Permalink to this headline">#</a></h4>
<p>It’s also important to check the estimated propensity scores. If they seem to cluster at zero or one, we should expect IPW and AIPW estimators to behave very poorly. Here, the propensity score is trimodal because of our sample modification procedure in Section (3.3): some observations are untouched and therefore remain with assignment probability <span class="math notranslate nohighlight">\(0.5\)</span>, some are dropped (kept) with probability 15% (85%).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">e_hat</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">set_axis_labels</span><span class="p">(</span><span class="s2">&quot;e_hat&quot;</span><span class="p">)</span>
<span class="c1"># g.set_titles(&quot;Estimated propensity scores (causal forest)&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Estimated propensity scores (causal forest)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Estimated propensity scores (causal forest)&#39;)
</pre></div>
</div>
<img alt="../_images/8_WGANs_for_simulation_100_1.png" src="../_images/8_WGANs_for_simulation_100_1.png" />
</div>
</div>
<p>This is the graph of the original data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Read and show image</span>
<span class="n">url6</span><span class="o">=</span><span class="s2">&quot;https://raw.githubusercontent.com/d2cml-ai/mgtecon634_py/main/figs/fig_6.png&quot;</span>
<span class="n">req6</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url6</span><span class="p">)</span>
<span class="n">im6</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">req6</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="n">im6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8_WGANs_for_simulation_102_0.png" src="../_images/8_WGANs_for_simulation_102_0.png" />
</div>
</div>
<p>When overlap fails, the methods described above will not produce good estimates. In that case, one may consider changing the estimand and targeting the average treatment effect <em>on the treated</em> (ATT) <span class="math notranslate nohighlight">\(\mathbf{E}[Y_i(1) - Y_i(0) | W_i=1]\)</span>, or trimming the sample and focusing on some subgroup <span class="math notranslate nohighlight">\(G_i\)</span> with bounded propensity scores <span class="math notranslate nohighlight">\(\mathbf{E}[Y_i(1) - Y_i(0) | G_i]\)</span>, as discussed in<br />
<a class="reference external" href="https://academic.oup.com/biomet/article/96/1/187/235329?login=true">Crump, Hotz, Imbens and Mitnik (Biometrika, 2009)</a>.</p>
<p>As we can see, all the results obtained with the synthetic data are quite similar to those of the original data.</p>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "d2cml-ai/mgtecon634_python",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="6_policy_learning_1.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">6. </span>Policy Learning I - Binary Treatment</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="9_surrogate_py.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">8. </span>Athey, S., Chetty, R., Imbens, G. W., &amp; Kang, H. (2019). The surrogate index: Combining short-term proxies to estimate long-term treatment effects more rapidly and precisely (No. w26463). National Bureau of Economic Research.</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Phd Susan Athey<br/>
  
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>