

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>5. Policy Evaluation I - Binary Treatment &#8212; MGTECON 634 at Stanford (Python scripts)</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/5_policy_evaluation_1';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6. Policy Learning I - Binary Treatment" href="6_policy_learning_1.html" />
    <link rel="prev" title="4. HTE I: Binary treatment" href="4_heterogeneous_treatment_effect_1.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../md/intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../md/intro.html">
                    Machine Learning-Based Causal Inference
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Topics</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1_introduction_1.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_introduction_to_machine_learning.html">2. Introduction to Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_average_treatment_effect_1.html">3. ATE I: Binary treatment</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_heterogeneous_treatment_effect_1.html">4. HTE I: Binary treatment</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">5. Policy Evaluation I - Binary Treatment</a></li>
<li class="toctree-l1"><a class="reference internal" href="6_policy_learning_1.html">6. Policy Learning I - Binary Treatment</a></li>
<li class="toctree-l1"><a class="reference internal" href="8_WGANs_for_simulation.html">7. Tutorial to simulate data using WGANs</a></li>
<li class="toctree-l1"><a class="reference internal" href="9_surrogate_py.html">8. Athey, S., Chetty, R., Imbens, G. W., &amp; Kang, H. (2019). The surrogate index: Combining short-term proxies to estimate long-term treatment effects more rapidly and precisely (No. w26463). National Bureau of Economic Research.</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/d2cml-ai/mgtecon634_python/master?urlpath=tree/_build/jupyter_execute/notebooks/5_policy_evaluation_1.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/d2cml-ai/mgtecon634_python/blob/master/_build/jupyter_execute/notebooks/5_policy_evaluation_1.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/d2cml-ai/mgtecon634_python" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/d2cml-ai/mgtecon634_python/edit/master/_build/jupyter_execute/notebooks/5_policy_evaluation_1.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/d2cml-ai/mgtecon634_python/issues/new?title=Issue%20on%20page%20%2Fnotebooks/5_policy_evaluation_1.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/5_policy_evaluation_1.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Policy Evaluation I - Binary Treatment</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#via-sample-means">5.1. Via sample means</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-difference-in-values">5.1.1. Estimating difference in values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#via-aipw-scores">5.1.2. Via AIPW scores</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#case-study">5.2. Case study</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading">5.3. Further reading</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123456</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="policy-evaluation-i-binary-treatment">
<h1><span class="section-number">5. </span>Policy Evaluation I - Binary Treatment<a class="headerlink" href="#policy-evaluation-i-binary-treatment" title="Permalink to this heading">#</a></h1>
<p>Source RMD file: <a class="reference external" href="https://docs.google.com/uc?export=download&amp;id=1TGPxR6L12kLeXbJeJBfCpXCnRFNA3hAC">link</a></p>
<p><font color="#fa8072">Note: this chapter is in ‘beta’ version and may be edited in the near future.</font></p>
<p>In previous chapters, you learned how to estimate the effect of a binary treatment on an outcome variable. We saw how to estimate the average treatment effect for the entire population <span class="math notranslate nohighlight">\(E[Y_i(1) - Y_i(0)]\)</span>, for specific subgroups <span class="math notranslate nohighlight">\(E[Y_i(1) - Y_i(0) | G_i]\)</span>, and at specific covariate values <span class="math notranslate nohighlight">\(E[Y_i(1) - Y_i(0)|X_i = x]\)</span>. One common feature of these quantities is that they compare the average effect of treating everyone (in the population, subgroup, etc) to the average effect of treating no one. But what if we had a <em>treatment rule</em> that dictated who should be treated, and who should not? Would treating some people according to this rule be better than treating no one? Can we compare two possible treatment rules? Questions like these abound in applied work, so here we’ll learn how to answer them using experimental and observational data (with appropriate assumptions).</p>
<p>Treatment rules that dictate which groups should be treatment are called <strong>policies</strong>. Formally, we’ll define a policy (for a binary treatment) to be a mapping from a vector of observable covariates to a number in the unit interval, i.e., <span class="math notranslate nohighlight">\(\pi: x \mapsto [0,1]\)</span>. Given some vector of covariates <span class="math notranslate nohighlight">\(x\)</span>, the expression <span class="math notranslate nohighlight">\(\pi(x) = 1\)</span> indicates a unit with this covariate value should be treated, <span class="math notranslate nohighlight">\(\pi(x) = 0\)</span> indicates no treatment, and  <span class="math notranslate nohighlight">\(\pi(x) = p \in (0, 1)\)</span> indicates randomization between treatment and control with probability <span class="math notranslate nohighlight">\(p\)</span>.</p>
<p>There are two main objects of interest in this chapter. The first is the <strong>value</strong> of a policy <span class="math notranslate nohighlight">\(\pi\)</span>, defined as the average outcome attained if we assign individuals to treatments according to the policy <span class="math notranslate nohighlight">\(\pi\)</span>,</p>
<div class="math notranslate nohighlight">
\[  E[Y_i(\pi(X_i))]. \]</div>
<p>The second object of interest is the <strong>difference in values</strong> between two policies <span class="math notranslate nohighlight">\(\pi\)</span> and <span class="math notranslate nohighlight">\(\pi'\)</span>,</p>
<div class="math notranslate nohighlight">
\[  E[Y_i(\pi(X_i)) - Y_i(\pi'(X_i))].\]</div>
<p>Note how the average treatment effect (ATE) we saw in previous chapters is a difference in values taking <span class="math notranslate nohighlight">\(\pi(x) \equiv 1 \)</span> (a policy that treats everyone) and <span class="math notranslate nohighlight">\(\pi(x) \equiv 0\)</span> (a policy that treats no one).</p>
<p>Importantly, in this chapter we’ll be working with policies that are <em>pre-specified</em> — that is, that were created or decided <em>before</em> looking at the data. In the next chapter, we’ll see how to estimate a policy with desirable properties from the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">uniform</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binom</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">statistics</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="via-sample-means">
<h2><span class="section-number">5.1. </span>Via sample means<a class="headerlink" href="#via-sample-means" title="Permalink to this heading">#</a></h2>
<p>To fix ideas, we will begin assuming that we are in a <em>randomized</em> setting. For concreteness, let’s work with the following toy setting with two uniformly-distributed covariates and a continuous outcome.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">p</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">binom</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># independent from X and Y</span>
<span class="n">Y</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">W</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here is a scatterplot of the data. Each data point is represented by a square if untreated or by a circle if treated in the eperiment. The shade of the point indicates the strength of the outcome, with more negative values being zero and more positive values being darker.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_norm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span> <span class="c1"># just for plotting</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> 
                <span class="n">y</span><span class="o">=</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">hue</span> <span class="o">=</span> <span class="o">-</span><span class="n">y_norm</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
               <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span>
            <span class="n">fontweight</span> <span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> 
            <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> 
            <span class="n">fontweight</span> <span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;x2&#39;)
</pre></div>
</div>
<img alt="../_images/58e2b552b0a1790b2c83ef9542b54da099f3c5a7fd293ad010f81d0f69385dcd.png" src="../_images/58e2b552b0a1790b2c83ef9542b54da099f3c5a7fd293ad010f81d0f69385dcd.png" />
</div>
</div>
<p>Here’s a graph of each treated and untreated population separately. Remark two things about this plot. First, the covariate distribution between the two plots is the same — which is what we should expect in a randomized setting. Second, observations with higher values of <span class="math notranslate nohighlight">\(X_2\)</span> react positively to treatment (their blobs are darker than the untreated counterparts, which observations with lower values of <span class="math notranslate nohighlight">\(X_2\)</span> react negatively (their blobs are lighter).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                      <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Untreated&quot;</span><span class="p">,</span> <span class="s2">&quot;Treated&quot;</span><span class="p">]</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;ax</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="n">y</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="n">hue</span> <span class="o">=</span> <span class="o">-</span><span class="n">y_norm</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="n">i</span><span class="p">],</span>
                                       <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">s</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
                                       <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">)</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;ax</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;ax</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;ax</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e5efc3154a4fd1fecd7f45eae8be95e89e7d0ca790bf33212ed14f1e100dfa29.png" src="../_images/e5efc3154a4fd1fecd7f45eae8be95e89e7d0ca790bf33212ed14f1e100dfa29.png" />
</div>
</div>
<p>As a first example, let’s estimate the value of the following policy (assuming that it was given to or decided by us prior to looking at the data):</p>
<div class="math notranslate nohighlight" id="equation-value-est">
<span class="eqno">(5.1)<a class="headerlink" href="#equation-value-est" title="Permalink to this equation">#</a></span>\[\begin{split}
  \pi(x) =
    \begin{cases} 
     1 \quad \text{if } x_1 &gt; .5 \text{ and } x_2 &gt; .5 \\
     0 \quad \text{otherwise}
    \end{cases}
\end{split}\]</div>
<p>This policy divides the plane into a “treatment” region <span class="math notranslate nohighlight">\(A\)</span> and a complementary “no treatment” region <span class="math notranslate nohighlight">\(A^c\)</span>,</p>
<div class="math notranslate nohighlight">
\[
  A := \{ x : \pi(x) = 1 \} = \{x: x_{1} &gt; .5, x_{2} &gt; .5\}.
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> 
                <span class="n">y</span><span class="o">=</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">hue</span> <span class="o">=</span> <span class="o">-</span><span class="n">y_norm</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
               <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span>
            <span class="n">fontweight</span> <span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> 
            <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> 
            <span class="n">fontweight</span> <span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.01</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="c1"># The fill color</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;goldenrod&#39;</span><span class="p">,</span>       <span class="c1"># The outline color</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>          <span class="c1"># Transparency of the fill</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.01</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="c1"># The fill color</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;goldenrod&#39;</span><span class="p">,</span>       <span class="c1"># The outline color</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>          <span class="c1"># Transparency of the fill</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.01</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.01</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
                 <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="c1"># The fill color</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cadetblue&#39;</span><span class="p">,</span>       <span class="c1"># The outline color</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>          <span class="c1"># Transparency of the fill</span>
<span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;serif&#39;</span><span class="p">,</span>
        <span class="s1">&#39;color&#39;</span><span class="p">:</span>  <span class="s1">&#39;BLACK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span>
        <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">20</span>
        <span class="p">}</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;DO NOT TREAT (A^C)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.65</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;TREAT (A)&#39;</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.65, 0.7, &#39;TREAT (A)&#39;)
</pre></div>
</div>
<img alt="../_images/70a1b1f9587e7374b950b7ec7280c18111053093ea647595c75c774d41ea8585.png" src="../_images/70a1b1f9587e7374b950b7ec7280c18111053093ea647595c75c774d41ea8585.png" />
</div>
</div>
<p>We’ll consider the behavior of the policy <span class="math notranslate nohighlight">\(\pi\)</span> separately within each region. In the “treatment” region <span class="math notranslate nohighlight">\(A\)</span>, its average outcome is the same as the average outcome for the treated population.</p>
<div class="math notranslate nohighlight" id="equation-pi-pop-value-1">
<span class="eqno">(5.2)<a class="headerlink" href="#equation-pi-pop-value-1" title="Permalink to this equation">#</a></span>\[\begin{split}
  \begin{aligned}
    E[Y_i(\pi(X_i)) \ | \ A] 
      &amp;= E[Y_i(1)|A]  \quad &amp;&amp;\text{because $\pi(x) = 1$ for all $x \in A$,} \\
      &amp;= E[Y_i|A, W_{i}=1]  \quad &amp;&amp;\text{randomized setting.} \\
  \end{aligned}
\end{split}\]</div>
<p>In the remaining region <span class="math notranslate nohighlight">\(A^c\)</span>, its average outcome is the same as the average outcome for the untreated population.</p>
<div class="math notranslate nohighlight" id="equation-pi-pop-value-2">
<span class="eqno">(5.3)<a class="headerlink" href="#equation-pi-pop-value-2" title="Permalink to this equation">#</a></span>\[\begin{split}
  \begin{aligned}
    E[Y_i(\pi(X_i)) \ | \ A^c] 
      &amp;= E[Y_i(0)|A^c]  \quad &amp;&amp;\text{because $\pi(x) = 0$ for all $x \in A^c$,} \\
      &amp;= E[Y_i|A, W_{i}=0]  \quad &amp;&amp;\text{randomized setting.} \\
  \end{aligned}
\end{split}\]</div>
<p>The expected value of <span class="math notranslate nohighlight">\(\pi\)</span> is a weighted average of value within each region:</p>
<div class="math notranslate nohighlight" id="equation-pi-pop-value">
<span class="eqno">(5.4)<a class="headerlink" href="#equation-pi-pop-value" title="Permalink to this equation">#</a></span>\[\begin{split}
\begin{align} 
    E[Y(\pi(X_i))] &amp;= E[Y_i | A, W_i = 1] P(A) +  E[Y_i | A^c, W_i = 0] P(A^c), \\
\end{align}
\end{split}\]</div>
<p>where we denote the probability of drawn a covariate from <span class="math notranslate nohighlight">\(A\)</span> as <span class="math notranslate nohighlight">\(P(A)\)</span>. In a randomized setting, we can estimate <a class="reference internal" href="#equation-pi-pop-value">(5.4)</a> by replacing population quantities by simple empirical counterparts based on sample averages; i.e., estimating <span class="math notranslate nohighlight">\(E[Y_i | A, W_i = 1]\)</span> by the sample average of outcomes among treated individuals in region <span class="math notranslate nohighlight">\(A\)</span>, <span class="math notranslate nohighlight">\(E[Y_i | A^c, W_i = 0]\)</span> by the sample average of outcomes among untreated individuals not in region <span class="math notranslate nohighlight">\(A\)</span>, and <span class="math notranslate nohighlight">\(P(A)\)</span> and <span class="math notranslate nohighlight">\(P(A^c)\)</span> by the proportions of individuals inside and outside of region <span class="math notranslate nohighlight">\(A\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only valid in randomized setting.</span>
<span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">value_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">)])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">)])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">value_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">)])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value estimate:&quot;</span><span class="p">,</span> <span class="n">value_estimate</span><span class="p">,</span> <span class="s2">&quot;Std. Error&quot;</span><span class="p">,</span> <span class="n">value_stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Value estimate: 0.15611207882074019 Std. Error 0.012557429457375606
</pre></div>
</div>
</div>
</div>
<p>For another example, let’s consider the value of a  <em>random</em> policy <span class="math notranslate nohighlight">\(\pi'\)</span> that would assign observations to treatment and control with probability <span class="math notranslate nohighlight">\(p\)</span>:</p>
<div class="math notranslate nohighlight">
\[ 
  \pi(X_i) = Z_i \qquad Z_i \sim^{iid} \text{Binomial}(p).
\]</div>
<p>To identify the value of this policy, follow the same argument as above. However, instead of thinking in terms of “regions”, consider the output of the random variable <span class="math notranslate nohighlight">\(Z_i\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-region-a">
<span class="eqno">(5.5)<a class="headerlink" href="#equation-region-a" title="Permalink to this equation">#</a></span>\[\begin{split}
  \begin{aligned}
    E[Y_i(\pi'(X_i)) \ | \ Z_i = 1]
      &amp;= E[Y_i(1)| Z_i = 1] \quad &amp;&amp;\text{because $\pi'(\cdot) = 1$ when $Z_i = 1$,} \\ 
      &amp;= E[Y_i(1)]          \quad &amp;&amp;\text{$Z_i$ is drawn independently,} \\
      &amp;= E[Y_i| W_{i}=1]  \quad &amp;&amp;\text{randomized setting.} \\
  \end{aligned}
\end{split}\]</div>
<p>We can proceed similarly for the case of <span class="math notranslate nohighlight">\(Z_i = 0\)</span>. Finally, since <span class="math notranslate nohighlight">\(P(Z_i = 1) = p\)</span>,</p>
<div class="math notranslate nohighlight" id="equation-region-a-1">
<span class="eqno">(5.6)<a class="headerlink" href="#equation-region-a-1" title="Permalink to this equation">#</a></span>\[ 
  E[Y_i(\pi'(X_i))] = pE[Y_i | W_i=1] + (1-p)E[Y_i | W_i = 0],
\]</div>
<p>which in a randomized setting can be estimated in a manner analogous to the previous example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only valid in randomized setting.</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">0.75</span> <span class="c1"># for example</span>
<span class="n">value_estimate</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">])</span> 
<span class="n">value_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value estimate:&quot;</span><span class="p">,</span> <span class="n">value_estimate</span><span class="p">,</span> <span class="s2">&quot;Std. Error&quot;</span><span class="p">,</span> <span class="n">value_stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Value estimate: 0.02113879730195745 Std. Error 0.013397723865885273
</pre></div>
</div>
</div>
</div>
<section id="estimating-difference-in-values">
<h3><span class="section-number">5.1.1. </span>Estimating difference in values<a class="headerlink" href="#estimating-difference-in-values" title="Permalink to this heading">#</a></h3>
<p>Next, let’s estimate the difference in value between two given policies. For a concrete example, let’s consider the gain from switching to <span class="math notranslate nohighlight">\(\pi\)</span> defined in <a class="reference internal" href="#equation-value-est">(5.1)</a> from a policy <span class="math notranslate nohighlight">\(\pi''\)</span> that never treats, i.e., <span class="math notranslate nohighlight">\(\pi''(X_i) \equiv 0\)</span>. That is,</p>
<div class="math notranslate nohighlight" id="equation-diff-0">
<span class="eqno">(5.7)<a class="headerlink" href="#equation-diff-0" title="Permalink to this equation">#</a></span>\[
  E[Y(\pi(X_i)) - Y(\pi''(X_i))].
\]</div>
<p>We already derived the value of <span class="math notranslate nohighlight">\(\pi\)</span> in <a class="reference internal" href="#equation-region-a-1">(5.6)</a>. To derive the value of the second policy,</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
  &amp;E[Y(\pi''(X_i))] \\ 
    &amp;= E[Y_i(0)] &amp;&amp; \text{$\pi''(x) = 0$ for all $x$,}  \\
    &amp;= E[Y_i(0)|A]P(A) + E[Y_i(0)|A^c]P(A^c) &amp;&amp; \text{law of total expectation,} \\
    &amp;= E[Y|A,W=0]P(A) + E[Y|A^c,W=0]P(A^c) &amp;&amp;\text{randomized setting.} 
\end{align} (ey0-expand)
\end{split}\]</div>
<p>Substituting <a class="reference internal" href="#equation-region-a-1">(5.6)</a> and <code class="xref eq docutils literal notranslate"><span class="pre">ey0-expand</span></code> into <a class="reference internal" href="#equation-diff-0">(5.7)</a> and simplifying,</p>
<div class="math notranslate nohighlight" id="equation-diff-0-result">
<span class="eqno">(5.8)<a class="headerlink" href="#equation-diff-0-result" title="Permalink to this equation">#</a></span>\[
  E[Y(\pi(X_i)) - Y(\pi''(X_i))]
    = \left( E[Y_i|A, W_i=1] - E[Y_i|A,W_i=0] \right) \cdot P(A) + 0 \cdot P(A^c) 
\]</div>
<p>Expression <a class="reference internal" href="#equation-diff-0-result">(5.8)</a> has the following intepretation. In region <span class="math notranslate nohighlight">\(A\)</span>, the policy  <span class="math notranslate nohighlight">\(\pi\)</span> treats, and the “never treat” policy does not; thus the gain in region <span class="math notranslate nohighlight">\(A\)</span> is the average treatment effect in that region, <span class="math notranslate nohighlight">\(E[Y_i(1) - Y_i(0)|A]\)</span>, which in a randomized setting equals the first term in parentheses. In region <span class="math notranslate nohighlight">\(A^{c}\)</span>, the policy <span class="math notranslate nohighlight">\(\pi\)</span> does not treat, but neither does the “never treat” policy. Therefore, there the different is exactly zero. The expected difference in values equals the weighted average of the difference in values within each region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only valid in randomized settings.</span>
<span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">diff_estimate</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">)])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">)]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">diff_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">)])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">A</span> <span class="o">&amp;</span> <span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Difference estimate:&quot;</span><span class="p">,</span> <span class="n">diff_estimate</span><span class="p">,</span> <span class="s2">&quot;Std. Error:&quot;</span><span class="p">,</span> <span class="n">diff_stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Difference estimate: 0.07199940525763421 Std. Error: 0.001257109582035781
</pre></div>
</div>
</div>
</div>
<p>For another example, let’s consider the difference in value between <span class="math notranslate nohighlight">\(\pi\)</span> and a <em>random</em> policy <span class="math notranslate nohighlight">\(\pi'\)</span> that assigns observations to treatment and control with equal probability <span class="math notranslate nohighlight">\(p = 1/2\)</span>. We have already derived an expression for value of the random policy in <a class="reference internal" href="#equation-region-a-1">(5.6)</a>. Subtracting it from the value of the policy <span class="math notranslate nohighlight">\(\pi\)</span> derived in <a class="reference internal" href="#equation-pi-pop-value">(5.4)</a> and simplifying,</p>
<div class="math notranslate nohighlight" id="equation-pi-pip-diff-results">
<span class="eqno">(5.9)<a class="headerlink" href="#equation-pi-pip-diff-results" title="Permalink to this equation">#</a></span>\[
\begin{align} 
  E[Y(\pi) - Y(\pi'(X_i))] 
    &amp;= \frac{P(A)}{2} \left( E[Y_i(1) - Y_i(0) | A] \right) +
      \frac{P(A^c)}{2} \left( E[Y_i(0) - Y_i(1) | A^c] \right) 
\end{align}
\]</div>
<p>Here’s how to interpret <a class="reference internal" href="#equation-pi-pip-diff-results">(5.9)</a>. In region <span class="math notranslate nohighlight">\(A\)</span>, policy <span class="math notranslate nohighlight">\(\pi\)</span> treats everyone, obtaining average value <span class="math notranslate nohighlight">\(E[Y_i(1)|A]\)</span>; meanwhile, policy <span class="math notranslate nohighlight">\(\pi'\)</span> treats half the observations (i.e., it treats each individual with one-half probability), obtaining average value <span class="math notranslate nohighlight">\((E[Y_i(1) + Y_i(0)|A])/2\)</span>. Subtracting the two gives the term multiplying <span class="math notranslate nohighlight">\(P(A)\)</span> in <a class="reference internal" href="#equation-pi-pip-diff-results">(5.9)</a>. In region <span class="math notranslate nohighlight">\(A^c\)</span>, policy <span class="math notranslate nohighlight">\(\pi\)</span> treats no one, obtaining average value <span class="math notranslate nohighlight">\(E[Y_i(0)|A]\)</span>; meanwhile, policy <span class="math notranslate nohighlight">\(\pi'\)</span> still obtains <span class="math notranslate nohighlight">\((E[Y_i(1) + Y_i(0)|A^c])/2\)</span> for the same reasons as above. Subtracting the two gives the term multiplying <span class="math notranslate nohighlight">\(P(A^c)\)</span> <a class="reference internal" href="#equation-pi-pip-diff-results">(5.9)</a>. Expression <a class="reference internal" href="#equation-pi-pip-diff-results">(5.9)</a> is the average of these two terms weighted by the size of each region.</p>
<p>Finally, in a randomized setting, <a class="reference internal" href="#equation-pi-pip-diff-results">(5.9)</a> is equivalent to</p>
<div class="amsmath math notranslate nohighlight" id="equation-fde5a854-7ebe-4aee-8f2f-8ace09338cbd">
<span class="eqno">(5.10)<a class="headerlink" href="#equation-fde5a854-7ebe-4aee-8f2f-8ace09338cbd" title="Permalink to this equation">#</a></span>\[\begin{align}
\frac{P(A)}{2} \left( E[Y|A,W=1] - E[Y|A,W=0] \right) + 
        \frac{P(A^c)}{2} \left( E[Y|A^c,W=0] - E[Y|A,W=1] \right),
\end{align}\]</div>
<p>which suggests an estimator based on sample averages as above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only valid in randomized settings.</span>
<span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">diff_estimate</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">)])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">)]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">)])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">)]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">diff_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">)])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">)])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">)])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">)])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">))))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Difference estimate:&quot;</span><span class="p">,</span> <span class="n">diff_estimate</span><span class="p">,</span> <span class="s2">&quot;Std. Error:&quot;</span><span class="p">,</span> <span class="n">diff_stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Difference estimate: 0.07898781938411295 Std. Error: 0.006289689990281425
</pre></div>
</div>
</div>
</div>
</section>
<section id="via-aipw-scores">
<h3><span class="section-number">5.1.2. </span>Via AIPW scores<a class="headerlink" href="#via-aipw-scores" title="Permalink to this heading">#</a></h3>
<p>In this section, we will use the following simulated <em>observational</em> setting. Note how the probability of receiving treatment varies by individual, but it depends only on observable characteristics (ensuring unconfoundedness) and it is bounded away from zero and one (ensuring overlap). We assume that assignment probabilities are not known to the researcher.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># An &quot;observational&quot; dataset satisfying unconfoundedness and overlap.</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">p</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">.5</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">.5</span><span class="p">)))</span>  <span class="c1"># not observed by the analyst.</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">binom</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>  
<span class="n">Y</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">W</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The next plot illustrates how treatment assignment isn’t independent from observed covariates. Individuals with high values of <span class="math notranslate nohighlight">\(X_{i,1}\)</span> and <span class="math notranslate nohighlight">\(X_{i,2}\)</span> are more likely to be treated and to have higher outcomes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span>
                      <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                      <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">aa</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Untreated&quot;</span><span class="p">,</span> <span class="s2">&quot;Treated&quot;</span><span class="p">]</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;ax</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="n">y</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="n">hue</span> <span class="o">=</span> <span class="o">-</span><span class="n">y_norm</span><span class="p">[</span><span class="n">W</span><span class="o">==</span><span class="n">i</span><span class="p">],</span>
                                       <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">s</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
                                       <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">)</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;ax</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">aa</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;ax</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">legend_</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="sa">f</span><span class="s2">&quot;ax</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4af9ad3298ab82897708a377c6b7f7f84aa7262ecc5d86073ad640675d31a85a.png" src="../_images/4af9ad3298ab82897708a377c6b7f7f84aa7262ecc5d86073ad640675d31a85a.png" />
</div>
</div>
<font size=1>
If we "naively" used the estimators based on sample averages above, the policy value estimate would be biased. Would the bias be upward or downward?
</font>
<p>In randomized setting and observational settings with unconfoundedness and overlap, there exists estimates of policy values and differences that are more efficient (i.e., they have smaller variance in large samples) than their counterparts based on sample averages. These are based on the <em>AIPW scores</em> that we studied in previous chapters. For example, to estimate the <span class="math notranslate nohighlight">\(E[Y_i(1)]\)</span></p>
<div class="math notranslate nohighlight" id="equation-gamma-1">
<span class="eqno">(5.11)<a class="headerlink" href="#equation-gamma-1" title="Permalink to this equation">#</a></span>\[
\begin{align} 
  \hat {\Gamma}_{i,1}
    &amp;= \hat{\mu}^{-i}(X_i, 1) + \frac{W_i}{\hat{e}^{-i}(X_i)} \left(Y_i -\hat{\mu}^{-i}(X_i, 1)\right) 
\end{align}
\]</div>
<p>As we discussed in the chapter on ATE, averaging over AIPW scores <a class="reference internal" href="#equation-gamma-1">(5.11)</a> across individuals yields an unbiased / consistent estimator of <span class="math notranslate nohighlight">\(E[Y_i(1)]\)</span> provided that at least one of <span class="math notranslate nohighlight">\(\hat{\mu}^{-i}(x, 1)\)</span> or <span class="math notranslate nohighlight">\(\hat{e}^{-i}(x)\)</span> is an unbiased / consistent estimator of the outcome model <span class="math notranslate nohighlight">\(\mu(x,w) := E[Y_i(w)|X_i=x]\)</span> or propensity model <span class="math notranslate nohighlight">\(e(x) := P[W_i=1|X_i=x]\)</span>. Provided that these are estimates using non-parametric methods like forests or neural networks, consistency should be guaranteed, and in addition the resulting estimates should have smaller asymptotic variance. Therefore, barring computational issues, AIPW-based estimates are usually superior to estimates based on sample means, even in randomized settings (though, for completeness, the latter should still be reported when valid).</p>
<p>For the control, we have the following estimator based on AIPW scores,</p>
<div class="math notranslate nohighlight" id="equation-gamma-0">
<span class="eqno">(5.12)<a class="headerlink" href="#equation-gamma-0" title="Permalink to this equation">#</a></span>\[
\begin{align} 
  \hat {\Gamma}_{i,0} 
    &amp;= \hat{\mu}^{-i}(X_i, 0) + \frac{1-W_i}{1-\hat{e}^{-i}(X_i)} \left(Y_i -\hat{\mu}^{-i}(X_i, 0)\right).
\end{align}
\]</div>
<p>To estimate the value of a binary policy <span class="math notranslate nohighlight">\(\pi\)</span>, we average over AIPW scores, selecting <a class="reference internal" href="#equation-gamma-1">(5.11)</a> or <a class="reference internal" href="#equation-gamma-0">(5.12)</a> for each individual depending on whether the policy dictates that the individual should be treated or not. That is, we estimate the value of a policy <span class="math notranslate nohighlight">\(\pi\)</span> via the following average,</p>
<div class="math notranslate nohighlight">
\[
\begin{align} 
  \frac{1}{n} \sum_{i=1}^n \hat {\Gamma}_{i,\pi(X_i)} 
  \qquad  
  \hat {\Gamma}_{i,\pi(X_i)} := \pi(X_i) \hat {\Gamma}_{i,1} + (1 - \pi(X_i)) \hat {\Gamma}_{i,0}.
\end{align}
\]</div>
<p>The next snippet construct AIPW scores via causal forests.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !pip install econml</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">econml</span>
<span class="c1"># Main imports</span>
<span class="kn">from</span> <span class="nn">econml.orf</span> <span class="kn">import</span> <span class="n">DMLOrthoForest</span><span class="p">,</span> <span class="n">DROrthoForest</span>
<span class="kn">from</span> <span class="nn">econml.dml</span> <span class="kn">import</span> <span class="n">CausalForestDML</span>
<span class="kn">from</span> <span class="nn">econml.sklearn_extensions.linear_model</span> <span class="kn">import</span> <span class="n">WeightedLassoCVWrapper</span><span class="p">,</span> <span class="n">WeightedLasso</span><span class="p">,</span> <span class="n">WeightedLassoCV</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">MultiTaskLassoCV</span>
<span class="c1"># Helper imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">LassoCV</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">LogisticRegressionCV</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">econml.grf</span> <span class="kn">import</span> <span class="n">RegressionForest</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">patsy</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\sandr\anaconda3\envs\renv\lib\site-packages\tqdm\auto.py:22: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid in observational and randomized settings</span>

<span class="c1"># Randomized settings: use the true assignment probability:</span>

<span class="c1"># Estimate a causal forest.</span>
<span class="c1"># Observational settings with unconfoundedness + overlap:</span>
<span class="n">forest</span> <span class="o">=</span> <span class="n">CausalForestDML</span><span class="p">(</span><span class="n">model_t</span><span class="o">=</span><span class="n">RegressionForest</span><span class="p">(),</span>  
                       <span class="n">model_y</span><span class="o">=</span><span class="n">RegressionForest</span><span class="p">(),</span>
                       <span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">max_depth</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forest</span><span class="o">.</span><span class="n">tune</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
<span class="n">forest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;econml.dml.causal_forest.CausalForestDML at 0x17f9bf0dc08&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate a causal forest</span>
<span class="n">tau_hat</span> <span class="o">=</span> <span class="n">forest</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span> <span class="c1"># tau(X) estimates</span>

<span class="c1"># Get residuals  and propensity </span>
<span class="n">residuals</span> <span class="o">=</span> <span class="n">forest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">cache_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">residuals_</span>
<span class="n">W_res</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">W_hat</span> <span class="o">=</span> <span class="n">W</span> <span class="o">-</span> <span class="n">W_res</span> 
<span class="n">Y_res</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Y_hat</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_res</span>

<span class="c1"># T = beta_hat*X + e , beta_hat*X = T_hat = T-e</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate outcome model for treated and propen</span>
<span class="n">mu_hat_1</span> <span class="o">=</span> <span class="n">Y_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">W_hat</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau_hat</span> <span class="c1"># E[Y|X,W=1] = E[Y|X] + (1-e(X))tau(X)</span>
<span class="n">mu_hat_0</span> <span class="o">=</span> <span class="n">Y_hat</span> <span class="o">-</span> <span class="n">W_hat</span> <span class="o">*</span> <span class="n">tau_hat</span>  <span class="c1"># E[Y|X,W=0] = E[Y|X] - e(X)tau(X)</span>

<span class="c1"># Compute AIPW scores</span>
<span class="n">gamma_hat_1</span> <span class="o">=</span> <span class="n">mu_hat_1</span> <span class="o">+</span> <span class="n">W</span><span class="o">/</span><span class="n">W_hat</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">mu_hat_1</span><span class="p">)</span>
<span class="n">gamma_hat_0</span> <span class="o">=</span> <span class="n">mu_hat_0</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">W</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">W_hat</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">mu_hat_0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once we have computed AIPW scores, we can compute the value of any policy. Here’s how to estimate the value of <a class="reference internal" href="#equation-value-est">(5.1)</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid in observational and randomized settings</span>
<span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">.5</span><span class="p">)</span>
<span class="n">gamma_hat_pi</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">gamma_hat_1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma_hat_0</span>
<span class="n">value_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gamma_hat_pi</span><span class="p">)</span>
<span class="n">value_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">gamma_hat_pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gamma_hat_pi</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value estimate:&quot;</span><span class="p">,</span> <span class="n">value_estimate</span><span class="p">,</span> <span class="s2">&quot;Std. Error:&quot;</span><span class="p">,</span> <span class="n">value_stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Value estimate: 0.06055691194127326 Std. Error: 0.00889781772419615
</pre></div>
</div>
</div>
</div>
<p>The next snippet estimates the value of a random policy that treats with 75% probability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid in observational and randomized settings</span>
<span class="n">pi_random</span> <span class="o">=</span> <span class="mf">0.75</span>
<span class="n">gamma_hat_pi</span> <span class="o">=</span> <span class="n">pi_random</span> <span class="o">*</span> <span class="n">gamma_hat_1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pi_random</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma_hat_0</span>
<span class="n">value_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gamma_hat_pi</span><span class="p">)</span>
<span class="n">value_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">gamma_hat_pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gamma_hat_pi</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value estimate:&quot;</span><span class="p">,</span> <span class="n">value_estimate</span><span class="p">,</span> <span class="s2">&quot;Std. Error:&quot;</span><span class="p">,</span> <span class="n">value_stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Value estimate: -0.0011862472819121658 Std. Error: 0.008966206859226581
</pre></div>
</div>
</div>
</div>
<p>To estimate the difference in value between two policies <span class="math notranslate nohighlight">\(\pi\)</span> and <span class="math notranslate nohighlight">\(\tilde{\pi}\)</span>, simply subtract the scores,</p>
<div class="math notranslate nohighlight">
\[
\begin{align}
  \frac{1}{n} \sum_{i=1}^n \hat {\Gamma}_{i,\pi(X_i)} - \hat {\Gamma}_{i,\tilde{\pi}(X_i)}.
\end{align}
\]</div>
<p>For example, here we estimate the difference between policy and the “never treat” policy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid in randomized settings and observational settings with unconfoundedness + overlap</span>

<span class="c1"># AIPW scores associated with first policy</span>
<span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">.5</span><span class="p">)</span>
<span class="n">gamma_hat_pi</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">gamma_hat_1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma_hat_0</span>

<span class="c1"># AIPW scores associated with second policy</span>
<span class="n">pi_never</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">gamma_hat_pi_never</span> <span class="o">=</span> <span class="n">pi_never</span> <span class="o">*</span> <span class="n">gamma_hat_1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pi_never</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma_hat_0</span>

<span class="c1"># Difference</span>
<span class="n">diff_scores</span> <span class="o">=</span> <span class="n">gamma_hat_pi</span> <span class="o">-</span> <span class="n">gamma_hat_pi_never</span> 
<span class="n">diff_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_scores</span><span class="p">)</span>
<span class="n">diff_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diff_scores</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">diff_scores</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diff estimate:&quot;</span><span class="p">,</span> <span class="n">diff_estimate</span><span class="p">,</span> <span class="s2">&quot;Std. Error:&quot;</span><span class="p">,</span> <span class="n">diff_stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Diff estimate: 0.06825894233218145 Std. Error: 0.005604938163933652
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="case-study">
<h2><span class="section-number">5.2. </span>Case study<a class="headerlink" href="#case-study" title="Permalink to this heading">#</a></h2>
<p>For completeness we’ll close out this section by estimating policy values using real data. Again, we’ll use an abridged version of the General Social Survey (GSS) <a class="reference external" href="https://gss.norc.org/Documents/reports/project-reports/GSSProject%20report32.pdf">(Smith, 2016)</a> dataset that was introduced in the previous chapter. In this dataset, individuals were sent to treatment or control with equal probability, so we are in a randomized setting.</p>
<font size=2>
(Please note that we have inverted the definitions of treatment and control)
</font><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span>  <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in data</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://drive.google.com/file/d/1kSxrVci_EUcSr_Lg1JKk1l7Xd5I9zfRC/view?usp=sharing&#39;</span>
<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;https://drive.google.com/uc?export=download&amp;id=&#39;</span><span class="o">+</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># NOTE: We&#39;ll invert treatment and control, compared to previous chapters</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span>

<span class="c1"># Treatment is the wording of the question:</span>
<span class="c1"># &#39;does the the gov&#39;t spend too much on &#39;assistance to the poor&#39; (control: 0)</span>
<span class="c1"># &#39;does the the gov&#39;t spend too much on &quot;welfare&quot;?&#39; (treatment: 1)</span>
<span class="n">treatment</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span>

<span class="c1"># Outcome: 1 for &#39;yes&#39;, 0 for &#39;no&#39;</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>

<span class="c1"># Additional covariates</span>
<span class="n">covariates</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;polviews&quot;</span><span class="p">,</span> <span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="s2">&quot;educ&quot;</span><span class="p">,</span> <span class="s2">&quot;marital&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll take the following policy as an example. It asks individuals who are older (age &gt; 50) or more conservative (<code class="docutils literal notranslate"><span class="pre">polviews</span></code> <span class="math notranslate nohighlight">\(\leq\)</span> 4) if they think the government spends to much on “welfare”, and it asks yonger and more liberal individuals if they think the government spends too much on “assistance to the poor”.</p>
<div class="math notranslate nohighlight" id="equation-polage">
<span class="eqno">(5.13)<a class="headerlink" href="#equation-polage" title="Permalink to this equation">#</a></span>\[\begin{split}
  \pi(x) =
    \begin{cases}
      1 \qquad \text{if }\texttt{polviews} \leq 4 \text{ OR } \texttt{age } &gt; 50  \\
      0 \qquad \text{otherwise}
    \end{cases}
\end{split}\]</div>
<p>We should expect that a higher number of individuals will answer ‘yes’ because, presumably, older and more conservative individuals in this sample may be more likely to be against welfare in the United States.</p>
<p>We selected policy <a class="reference internal" href="#equation-polage">(5.13)</a> purely for illustrative purposes, but it’s not hard to come up with examples where understanding how to word certain questions and prompts can be useful. For example, a non-profit that champions assistance to the poor may be able to obtain more donations if they advertise themselves as champions of “welfare” or “assistance to the poor” to different segments of the population.</p>
<p>Since this is a randomized setting, we can estimate its value via sample averages.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only valid in randomized setting</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">covariates</span><span class="p">]</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span>
  
<span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;polviews&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="s2">&quot;age&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">value_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">)])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">)])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">value_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">)])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">A</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">)])</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">W</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">A</span><span class="o">!=</span><span class="mi">1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value estimate:&quot;</span><span class="p">,</span> <span class="n">value_estimate</span><span class="p">,</span> <span class="s2">&quot;Std. Error&quot;</span><span class="p">,</span> <span class="n">value_stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Value estimate: 0.3964638929438347 Std. Error 0.00466293591374913
</pre></div>
</div>
</div>
</div>
<p>The result above suggests that if we assign older and more conservative individuals about “welfare”, and other individuals about “assistance to the poor”, then on average about 34.6% of individuals respond ‘yes’.</p>
<p>The next snippet uses AIPW-based estimates, which would also have been valid had the data been collected in an observational setting with unconfoundedness and overlap.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid in randomized settings and observational settings with unconfoundedness + overlap</span>
<span class="n">fmla</span> <span class="o">=</span> <span class="s1">&#39;0+age+polviews+income+educ+marital+sex&#39;</span>
<span class="n">desc</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">ModelDesc</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="n">fmla</span><span class="p">)</span>
<span class="n">desc</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">return_type</span> <span class="o">=</span> <span class="s2">&quot;dataframe&quot;</span><span class="p">)</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">]</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">matrix</span>
<span class="n">W</span> <span class="o">=</span> <span class="kc">None</span> 

<span class="c1"># Estimate a causal forest</span>
<span class="c1"># Important: comment/uncomment as appropriate.</span>
<span class="c1"># Randomized setting (known, fixed assignment probability)</span>
<span class="n">forest</span> <span class="o">=</span> <span class="n">CausalForestDML</span><span class="p">(</span><span class="n">model_t</span><span class="o">=</span><span class="n">RegressionForest</span><span class="p">(),</span>
                       <span class="n">model_y</span><span class="o">=</span><span class="n">RegressionForest</span><span class="p">(),</span>
                       <span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">max_depth</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>

<span class="n">forest</span><span class="o">.</span><span class="n">tune</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>
<span class="n">forest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">W</span><span class="p">)</span>


<span class="c1"># Estimate a causal forest</span>
<span class="n">tau_hat</span> <span class="o">=</span> <span class="n">forest</span><span class="o">.</span><span class="n">effect</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span> <span class="c1"># tau(X) estimates</span>

<span class="c1"># Get residuals  and propensity </span>
<span class="n">residuals</span> <span class="o">=</span> <span class="n">forest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">cache_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">residuals_</span>
<span class="n">T_res</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">T_hat</span> <span class="o">=</span> <span class="n">T</span> <span class="o">-</span> <span class="n">T_res</span> 
<span class="n">Y_res</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Y_hat</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">Y_res</span>

<span class="c1"># Estimate outcome model for treated and propen</span>
<span class="n">mu_hat_1</span> <span class="o">=</span> <span class="n">Y_hat</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">T_hat</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau_hat</span> <span class="c1"># E[Y|X,W=1] = E[Y|X] + (1-e(X))tau(X)</span>
<span class="n">mu_hat_0</span> <span class="o">=</span> <span class="n">Y_hat</span> <span class="o">-</span> <span class="n">T_hat</span> <span class="o">*</span> <span class="n">tau_hat</span>  <span class="c1"># E[Y|X,W=0] = E[Y|X] - e(X)tau(X)</span>

<span class="c1"># Compute AIPW scores</span>
<span class="n">gamma_hat_1</span> <span class="o">=</span> <span class="n">mu_hat_1</span> <span class="o">+</span> <span class="n">T</span><span class="o">/</span><span class="n">T_hat</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">mu_hat_1</span><span class="p">)</span>
<span class="n">gamma_hat_0</span> <span class="o">=</span> <span class="n">mu_hat_0</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">T_hat</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">mu_hat_0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As expected, the results are very similar (as they should be since they are both valid in a randomized seting).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid in randomized settings and observational settings with unconfoundedness + overlap</span>
<span class="n">gamma_hat_pi</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">gamma_hat_1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma_hat_0</span>
<span class="n">value_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gamma_hat_pi</span><span class="p">)</span>
<span class="n">value_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">gamma_hat_pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gamma_hat_pi</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value estimate:&quot;</span><span class="p">,</span> <span class="n">value_estimate</span><span class="p">,</span> <span class="s2">&quot;Std. Error:&quot;</span><span class="p">,</span> <span class="n">value_stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Value estimate: 0.3525628046921557 Std. Error: 0.004050084053091235
</pre></div>
</div>
</div>
</div>
<p>The next snippet estimates the value of policy <a class="reference internal" href="#equation-polage">(5.13)</a> and a random policy that assigns to treatment and control with equal probability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid in randomized settings and observational settings with unconfoundedness + overlap</span>
<span class="n">pi_2</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">gamma_hat_pi_1</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">gamma_hat_1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma_hat_0</span>
<span class="n">gamma_hat_pi_2</span> <span class="o">=</span> <span class="n">pi_2</span> <span class="o">*</span> <span class="n">gamma_hat_1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pi_2</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma_hat_0</span>
<span class="n">gamma_hat_pi_diff</span> <span class="o">=</span> <span class="n">gamma_hat_pi_1</span> <span class="o">-</span> <span class="n">gamma_hat_pi_2</span>
<span class="n">diff_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gamma_hat_pi_diff</span><span class="p">)</span>
<span class="n">diff_stderr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">gamma_hat_pi_diff</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gamma_hat_pi_diff</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Difference estimate:&quot;</span><span class="p">,</span> <span class="n">diff_estimate</span><span class="p">,</span> <span class="s2">&quot;Std. Error:&quot;</span><span class="p">,</span> <span class="n">diff_stderr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Difference estimate: 0.08614468301770545 Std. Error: 0.002587161117215462
</pre></div>
</div>
</div>
</div>
<p>The result suggests that assigning observations to treatment as in <a class="reference internal" href="#equation-polage">(5.13)</a> produces 8% more positive responses than assigning individuals at uniformly at random.</p>
</section>
<section id="further-reading">
<h2><span class="section-number">5.3. </span>Further reading<a class="headerlink" href="#further-reading" title="Permalink to this heading">#</a></h2>
<p><a class="reference external" href="https://arxiv.org/abs/1702.02896">Athey and Wager (2020, Econometrica)</a> has a good review of the literature on policy learning and evaluation. For a more accessible introduction to the theory, see
<a class="reference external" href="https://web.stanford.edu/~swager/stats361.pdf">Stefan Wager’s lecture notes</a>, lecture 7. However, both references focus heavily on policy learning, which will be the topic of the next chapter.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "d2cml-ai/mgtecon634_python",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="4_heterogeneous_treatment_effect_1.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">4. </span>HTE I: Binary treatment</p>
      </div>
    </a>
    <a class="right-next"
       href="6_policy_learning_1.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">6. </span>Policy Learning I - Binary Treatment</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#via-sample-means">5.1. Via sample means</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-difference-in-values">5.1.1. Estimating difference in values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#via-aipw-scores">5.1.2. Via AIPW scores</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#case-study">5.2. Case study</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading">5.3. Further reading</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Susan Athey. Translated into Python by Alexander Quispe
</p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>