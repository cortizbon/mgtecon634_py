
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Counterfactual value estimation using outcome imputation &#8212; MGTECON 634 at Stanford (Python scripts)</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">MGTECON 634 at Stanford (Python scripts)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../md/intro.html">
                    Machine Learning-Based Causal Inference
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/1_introduction_1.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/2_introduction_to_machine_learning.html">
   2. Introduction to Machine Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/3_average_treatment_effect_1.html">
   3. ATE I: Binary treatment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/4_heterogeneous_treatment_effect_1.html">
   4. HTE I: Binary treatment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/5_policy_evaluation_1.html">
   5. Policy Evaluation I - Binary Treatment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/6_policy_learning_1.html">
   6. Policy Learning I - Binary Treatment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/8_WGANs_for_simulation.html">
   7. Tutorial to simulate data using WGANs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notebooks/9_surrogate_py.html">
   8. The surrogate index Athey, S., et al. (2019).
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/d2cml-ai/mgtecon634_python/master?urlpath=tree/_build/jupyter_execute/causalml/examples/counterfactual_value_optimization.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/d2cml-ai/mgtecon634_python/blob/master/_build/jupyter_execute/causalml/examples/counterfactual_value_optimization.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/d2cml-ai/mgtecon634_python"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/d2cml-ai/mgtecon634_python/issues/new?title=Issue%20on%20page%20%2Fcausalml/examples/counterfactual_value_optimization.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/d2cml-ai/mgtecon634_python/edit/master/_build/jupyter_execute/causalml/examples/counterfactual_value_optimization.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/causalml/examples/counterfactual_value_optimization.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-generation">
   Data generation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-evaluation">
   Model evaluation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-against-benchmarks">
     Performance against benchmarks
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Counterfactual value estimation using outcome imputation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-generation">
   Data generation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-evaluation">
   Model evaluation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#performance-against-benchmarks">
     Performance against benchmarks
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="counterfactual-value-estimation-using-outcome-imputation">
<h1>Counterfactual value estimation using outcome imputation<a class="headerlink" href="#counterfactual-value-estimation-using-outcome-imputation" title="Permalink to this headline">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>The goal in uplift modeling is usually to predict the best treatment condition for an individual. Most of the time, the best treatment condition is assumed to be the one that has the highest probability of some “conversion event” such as the individual’s purchasing a product. This is the traditional approach in which the goal is to maximize conversion.</p>
<p>However, if the goal of uplift modeling is to maximize value, then it is not safe to assume that the best treatment group is the one with the highest expected conversion. For example, it might be that the payoff from conversion is not sufficient to offset the cost of the treatment, or it might be that the treatment targets individuals who would convert anyway <a class="reference external" href="https://ftp.cs.ucla.edu/pub/stat_ser/r488.pdf">(Li and Pearl 2019)</a>. Therefore, it is often important to conduct some kind of value optimization together with uplift modeling, in order to determine the treatment group with the best value, not just the best lift.</p>
<p>The Causal ML package includes the CounterfactualValueEstimator class to conduct simple imputation-based value optimization. This notebook demonstrates the use of CounterfactualValueEstimator to determine the best treatment group when the costs of treatments are taken into account. We consider two kinds of costs:</p>
<ul class="simple">
<li><p><strong>Conversion costs</strong> are those that we must endure if an individual who is in the treatment group converts. A typical example would be the cost of a promotional voucher.</p></li>
<li><p><strong>Impression costs</strong> are those that we need to pay for each individual in the treatment group irrespective of whether they convert. A typical example would be the cost associated with sending an SMS or email.</p></li>
</ul>
<p>The proposed method takes two inputs: the CATE estimate <span class="math notranslate nohighlight">\(\hat{\tau}\)</span> learned by any suitable method, and the predicted outcome for an individual learned by what we call the conversion probability model that estimates the conditional probability of conversion <span class="math notranslate nohighlight">\(P(Y=1 \mid X=x, W=x)\)</span> where <span class="math notranslate nohighlight">\(W\)</span> is the treatment group indicator. That is, the model estimates the probability of conversion for each individual using their observed pre-treatment features <span class="math notranslate nohighlight">\(X\)</span>. The output of this model is then combined with the predicted CATE in order to impute the expected conversion probability for each individual under \textit{each treatment condition} as follows:</p>
<div class="amsmath math notranslate nohighlight" id="equation-c78039f1-ea9b-44ce-9c88-5bcc300fe20e">
<span class="eqno">()<a class="headerlink" href="#equation-c78039f1-ea9b-44ce-9c88-5bcc300fe20e" title="Permalink to this equation">#</a></span>\[\begin{equation}
\hat{Y}_i^0 = 
    \begin{cases}
    \hat{m}(X_i, W_i) &amp; \text{for } W_i = 0 \\
    \hat{m}(X_i, W_i) - \hat{\tau}_t(X_i) &amp; \text{for } W_i = t \\
    \end{cases}
\end{equation}\]</div>
<div class="amsmath math notranslate nohighlight" id="equation-18467558-5253-41b7-818d-da67d12e061d">
<span class="eqno">()<a class="headerlink" href="#equation-18467558-5253-41b7-818d-da67d12e061d" title="Permalink to this equation">#</a></span>\[\begin{equation}
\hat{Y}_i^t = 
    \begin{cases}
    \hat{m}(X_i, W_i) + \hat{\tau}_t(X_i) &amp; \text{for } W_i = 0 \\
    \hat{m}(X_i, W_i) &amp; \text{for } W_i = t \\
    \end{cases}
\end{equation}\]</div>
<p>The fact that we impute the conversion probability under each experimental condition–the actual as well as the counterfactual–gives our method its name. Using the estimated conversion probabilities, we then compute the expected payoff under each treatment condition while taking into account the value of conversion and the conversion and impression costs associated with each treatment, as follows (see <a class="reference external" href="https://arxiv.org/abs/1908.05372">Zhao and Harinen (2019)</a> for more details):</p>
<div class="amsmath math notranslate nohighlight" id="equation-a3fd81a0-9ea1-49ad-9bcf-183bac96c9d9">
<span class="eqno">()<a class="headerlink" href="#equation-a3fd81a0-9ea1-49ad-9bcf-183bac96c9d9" title="Permalink to this equation">#</a></span>\[\begin{equation}
    \mathbb{E}[(v - cc_t)Y_t - ic_t]
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(cc_t\)</span> and <span class="math notranslate nohighlight">\(ic_t\)</span> are the conversion costs and impression costs, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>

<span class="kn">from</span> <span class="nn">causalml.dataset</span> <span class="kn">import</span> <span class="n">make_uplift_classification</span>
<span class="kn">from</span> <span class="nn">causalml.inference.meta</span> <span class="kn">import</span> <span class="n">BaseTClassifier</span>
<span class="kn">from</span> <span class="nn">causalml.optimize</span> <span class="kn">import</span> <span class="n">CounterfactualValueEstimator</span>
<span class="kn">from</span> <span class="nn">causalml.optimize</span> <span class="kn">import</span> <span class="n">get_treatment_costs</span>
<span class="kn">from</span> <span class="nn">causalml.optimize</span> <span class="kn">import</span> <span class="n">get_actual_value</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">)</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The sklearn.utils.testing module is  deprecated in version 0.22 and will be removed in version 0.24. The corresponding classes / functions should instead be imported from sklearn.utils. Anything that cannot be imported from sklearn.utils is now part of the private API.
sklearn.tree._criterion.RegressionCriterion size changed, may indicate binary incompatibility. Expected 168 from C header, got 360 from PyObject
sklearn.tree._criterion.Criterion size changed, may indicate binary incompatibility. Expected 160 from C header, got 352 from PyObject
sklearn.tree._criterion.ClassificationCriterion size changed, may indicate binary incompatibility. Expected 176 from C header, got 368 from PyObject
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-generation">
<h2>Data generation<a class="headerlink" href="#data-generation" title="Permalink to this headline">#</a></h2>
<p>First, we simulate some heterogeneous treatment data using the built-in function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">,</span> <span class="n">X_names</span> <span class="o">=</span> <span class="n">make_uplift_classification</span><span class="p">(</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">treatment_name</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment1&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment2&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>In this example, we assume there are no costs associated with assigning units into the control group, and that for the two treatment groups the conversion cost are \<span class="math notranslate nohighlight">\(2.5 and \\\)</span>5, respectively. We assume the impression costs to be zero for one of the treatments and \<span class="math notranslate nohighlight">\(0.02 for the other. We also specify the payoff, which we here assume to be the same for everyone, \\\)</span>20. However, these values could vary from individual to individual.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Put costs into dicts</span>
<span class="n">conversion_cost_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;treatment1&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span> <span class="s1">&#39;treatment2&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
<span class="n">impression_cost_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;treatment1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;treatment2&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">}</span>

<span class="c1"># Use a helper function to put treatment costs to array</span>
<span class="n">cc_array</span><span class="p">,</span> <span class="n">ic_array</span><span class="p">,</span> <span class="n">conditions</span> <span class="o">=</span> <span class="n">get_treatment_costs</span><span class="p">(</span><span class="n">treatment</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment_group_key&#39;</span><span class="p">],</span>
                                                     <span class="n">control_name</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">,</span>
                                                     <span class="n">cc_dict</span><span class="o">=</span><span class="n">conversion_cost_dict</span><span class="p">,</span>
                                                     <span class="n">ic_dict</span><span class="o">=</span><span class="n">impression_cost_dict</span><span class="p">)</span>

<span class="c1"># Put the conversion value into an array</span>
<span class="n">conversion_value_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next we calculate the value of actually having an individual in their actual treatment group using the equation for expected value under a treatment, ie:</p>
<div class="amsmath math notranslate nohighlight" id="equation-92b1a198-5d80-4e26-8546-6c7483195d35">
<span class="eqno">()<a class="headerlink" href="#equation-92b1a198-5d80-4e26-8546-6c7483195d35" title="Permalink to this equation">#</a></span>\[\begin{equation}
    \mathbb{E}[(v - cc_t)Y_t - ic_t]
\end{equation}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use a helper function to obtain the value of actual treatment</span>
<span class="n">actual_value</span> <span class="o">=</span> <span class="n">get_actual_value</span><span class="p">(</span><span class="n">treatment</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment_group_key&#39;</span><span class="p">],</span>
                                <span class="n">observed_outcome</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;conversion&#39;</span><span class="p">],</span>
                                <span class="n">conversion_value</span><span class="o">=</span><span class="n">conversion_value_array</span><span class="p">,</span>
                                <span class="n">conditions</span><span class="o">=</span><span class="n">conditions</span><span class="p">,</span>
                                <span class="n">conversion_cost</span><span class="o">=</span><span class="n">cc_array</span><span class="p">,</span>
                                <span class="n">impression_cost</span><span class="o">=</span><span class="n">ic_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">actual_value</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/counterfactual_value_optimization_10_0.png" src="../../_images/counterfactual_value_optimization_10_0.png" />
</div>
</div>
</section>
<section id="model-evaluation">
<h2>Model evaluation<a class="headerlink" href="#model-evaluation" title="Permalink to this headline">#</a></h2>
<p>A common problem in the uplift modeling literature is that of evaluating the quality of the treatment recommendations produced by a model. The evaluation of uplift models is tricky because we do not observe treatment effects at an individual level directly in non-simulated data, so it is not possible to use standard model evaluation metrics such as mean squared error. Consequently, various authors have proposed various ways to work around this issue. For example, <a class="reference external" href="https://arxiv.org/abs/1804.05146">Schuler et al (2018)</a> identify seven different evaluation strategies used in the literature.</p>
<p>Below, we use the approach of model evaluation put forward by <a class="reference external" href="https://arxiv.org/abs/1404.7844">Kaepelner et al (2014)</a>. The idea in this method is to evaluate the improvement we would gain if we targeted some as-yet untreated future population by using the recommendations produced by a particular model. To do so, we split the data into disjoint training and testing sets, and train our model on the training data. We then use the model to predict the best treatment group for units in the testing data, which in a simple two-arm trial is either treatment or control. In order to estimate the outcome for the future population if the model were to be used, we then select a subset of the testing data based on whether their observed treatment allocation happens to be the same as the one recommended by the model. This population is called “lucky”.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Predicted best treatment</p></th>
<th class="head"><p>Actual treatment</p></th>
<th class="head"><p>Lucky</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Control</p></td>
<td><p>Control</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>Control</p></td>
<td><p>Treatment</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>Treatment</p></td>
<td><p>Treatment</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>Treatment</p></td>
<td><p>Control</p></td>
<td><p>No</p></td>
</tr>
</tbody>
</table>
<p>The average outcome for the “lucky” population can be taken to represent what the outcome would be for a future untreated population if we were to use the uplift model in question to allocate treatments. Recall that in all of the experiments the treatments are assumed to have been allocated randomly across the total population, so there should be no selection bias. The average outcome under a given model can then be compared with alternative treatment allocation strategies. As <a class="reference external" href="https://arxiv.org/abs/1404.7844">Kaepelner et al (2014)</a> point out, two common strategies are random allocation and “best treatment” allocation. To estimate what the outcome for a future population would be under random allocation, we can simply look at the sample mean across the total test population. To estimate the same for the “best treatment” assignment, we can look at those units in the test set whose observed treatment assignment corresponds to the treatment group with the best average treatment effect. These alternative targeting strategies are interesting because they are a common practice in industry applications and elsewhere.</p>
<section id="performance-against-benchmarks">
<h3>Performance against benchmarks<a class="headerlink" href="#performance-against-benchmarks" title="Permalink to this headline">#</a></h3>
<p>In this section, we compare four different targeting strategies:</p>
<ul class="simple">
<li><p>Random treatment allocation under which all units in the testing set are randomly assigned to treatments</p></li>
<li><p>The “best treatment” allocation under which all units in the testing set are assigned to the treatment with the best conversion in the training set</p></li>
<li><p>Allocation under an uplift model in which all units in the testing set are assigned to the treatment which is predicted to have the highest conversion rate according to an uplift model trained on the training set</p></li>
<li><p>Allocation under the counterfactual value estimator model in which all units are assigned to the treatment group with the best predicted payoff</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">train_idx</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">index</span>
<span class="n">test_idx</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the benchmark value according to the random allocation</span>
<span class="c1"># and best treatment schemes</span>
<span class="n">random_allocation_value</span> <span class="o">=</span> <span class="n">actual_value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">best_ate</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="s1">&#39;treatment_group_key&#39;</span><span class="p">)[</span><span class="s1">&#39;conversion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>

<span class="n">actual_is_best_ate</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;treatment_group_key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">best_ate</span>

<span class="n">best_ate_value</span> <span class="o">=</span> <span class="n">actual_value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">][</span><span class="n">actual_is_best_ate</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the value under an uplift model </span>
<span class="n">tm</span> <span class="o">=</span> <span class="n">BaseTClassifier</span><span class="p">(</span><span class="n">control_learner</span><span class="o">=</span><span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(),</span>
                     <span class="n">treatment_learner</span><span class="o">=</span><span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">(),</span>
                     <span class="n">control_name</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">)</span>

<span class="n">tm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="n">X_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
       <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;treatment_group_key&#39;</span><span class="p">],</span>
       <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;conversion&#39;</span><span class="p">])</span>

<span class="n">tm_pred</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="n">X_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="n">pred_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tm_pred</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">tm</span><span class="o">.</span><span class="n">_classes</span><span class="p">)</span>
<span class="n">tm_best</span> <span class="o">=</span> <span class="n">pred_df</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">actual_is_tm_best</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;treatment_group_key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tm_best</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">tm_value</span> <span class="o">=</span> <span class="n">actual_value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">][</span><span class="n">actual_is_tm_best</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate the conditional mean model; this is a pure curve</span>
<span class="c1"># fitting exercise</span>
<span class="n">proba_model</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">()</span>

<span class="n">W_dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment_group_key&#39;</span><span class="p">])</span>
<span class="n">XW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">X_names</span><span class="p">],</span> <span class="n">W_dummies</span><span class="p">]</span>

<span class="n">proba_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">XW</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">df_train</span><span class="p">[</span><span class="s1">&#39;conversion&#39;</span><span class="p">])</span>
<span class="n">y_proba</span> <span class="o">=</span> <span class="n">proba_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">XW</span><span class="p">[</span><span class="n">test_idx</span><span class="p">])[:,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the counterfactual calculation with TwoModel prediction</span>
<span class="n">cve</span> <span class="o">=</span> <span class="n">CounterfactualValueEstimator</span><span class="p">(</span><span class="n">treatment</span><span class="o">=</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;treatment_group_key&#39;</span><span class="p">],</span>
                                   <span class="n">control_name</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">,</span>
                                   <span class="n">treatment_names</span><span class="o">=</span><span class="n">conditions</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                                   <span class="n">y_proba</span><span class="o">=</span><span class="n">y_proba</span><span class="p">,</span>
                                   <span class="n">cate</span><span class="o">=</span><span class="n">tm_pred</span><span class="p">,</span>
                                   <span class="n">value</span><span class="o">=</span><span class="n">conversion_value_array</span><span class="p">[</span><span class="n">test_idx</span><span class="p">],</span>
                                   <span class="n">conversion_cost</span><span class="o">=</span><span class="n">cc_array</span><span class="p">[</span><span class="n">test_idx</span><span class="p">],</span>
                                   <span class="n">impression_cost</span><span class="o">=</span><span class="n">ic_array</span><span class="p">[</span><span class="n">test_idx</span><span class="p">])</span>

<span class="n">cve_best_idx</span> <span class="o">=</span> <span class="n">cve</span><span class="o">.</span><span class="n">predict_best</span><span class="p">()</span>
<span class="n">cve_best</span> <span class="o">=</span> <span class="p">[</span><span class="n">conditions</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cve_best_idx</span><span class="p">]</span>
<span class="n">actual_is_cve_best</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">,</span> <span class="s1">&#39;treatment_group_key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cve_best</span>
<span class="n">cve_value</span> <span class="o">=</span> <span class="n">actual_value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_idx</span><span class="p">][</span><span class="n">actual_is_cve_best</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Random allocation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Best treatment&#39;</span><span class="p">,</span>
    <span class="s1">&#39;T-Learner&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CounterfactualValueEstimator&#39;</span>
<span class="p">]</span>

<span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">random_allocation_value</span><span class="p">,</span>
    <span class="n">best_ate_value</span><span class="p">,</span>
    <span class="n">tm_value</span><span class="p">,</span>
    <span class="n">cve_value</span>
<span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean actual value in testing set&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/counterfactual_value_optimization_21_0.png" src="../../_images/counterfactual_value_optimization_21_0.png" />
</div>
</div>
<p>Here, only CounterfactualValueEstimator improves upon random targeting. The “best treatment” and T-Learner approaches likely perform worse because they recommend costly treatments to individuals who would convert anyway.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "d2cml-ai/mgtecon634_python",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./causalml/examples"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Phd Susan Athey<br/>
  
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>